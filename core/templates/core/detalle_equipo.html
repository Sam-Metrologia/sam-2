{% extends 'base.html' %}
{% load static %}
{% load file_tags %}

{# Título para la pestaña del navegador #}
{% block title %}Detalle del Equipo - {{ equipo.nombre }}{% endblock %}

{# Título para el encabezado de la página #}
{% block header_title %}Detalle del Equipo{% endblock %}

{% block extra_head %}
<style>
    /* Hacer que los SVGs sean responsive */
    .bg-gray-50 svg {
        max-width: 100%;
        height: auto;
        display: block;
    }

    /* Asegurar que el contenedor de gráficas no desborde */
    .overflow-x-auto {
        -webkit-overflow-scrolling: touch;
    }

    /* En pantallas pequeñas, permitir scroll horizontal */
    @media (max-width: 640px) {
        .bg-gray-50 svg {
            min-width: 400px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
        <!-- Indicador de posicion y navegacion (NUEVO 2025-11-19) -->
        {% if current_position and total_equipos %}
        <div class="mb-4 flex items-center justify-between">
            <div>
                {% if prev_equipo_id %}
                <a href="{% url 'core:detalle_equipo' prev_equipo_id %}"
                   class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out inline-block">
                    <i class="fas fa-arrow-left"></i> Anterior
                </a>
                {% endif %}
            </div>
            <div class="text-center">
                <span class="inline-block bg-blue-100 text-blue-800 px-4 py-2 rounded-full font-semibold">
                    <i class="fas fa-list-ol"></i> Equipo {{ current_position }} de {{ total_equipos }}
                </span>
            </div>
            <div>
                {% if next_equipo_id %}
                <a href="{% url 'core:detalle_equipo' next_equipo_id %}"
                   class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out inline-block">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
            <h1 class="text-3xl font-bold text-gray-800">Detalle del Equipo: {{ equipo.nombre }} ({{ equipo.codigo_interno }})</h1>
            <div class="flex flex-wrap space-x-2 gap-2">
                {% if perms.core.change_equipo %}
                <a href="{% url 'core:editar_equipo' equipo.pk %}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Editar Equipo
                </a>
                {% endif %}
                {# Botón para generar Hoja de Vida en PDF - Visible para todos los usuarios autenticados #}
                <a href="{% url 'core:generar_hoja_vida_pdf' equipo.pk %}" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-file-pdf mr-2"></i> Descargar Hoja de Vida PDF
                </a>
                
                {# === Lógica para botones de Estado: Dar de Baja, Inactivar, Activar === #}
                {% if equipo.estado == 'Activo' %} {# Cualquier usuario autenticado puede inactivar/dar de baja si el equipo está activo #}
                    <a href="{% url 'core:inactivar_equipo' equipo.pk %}" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        <i class="fas fa-pause-circle mr-2"></i> Inactivar Equipo
                    </a>
                    <a href="{% url 'core:dar_baja_equipo' equipo.pk %}" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        <i class="fas fa-minus-circle mr-2"></i> Dar de Baja
                    </a>
                {% elif equipo.estado == 'Inactivo' or equipo.estado == 'De Baja' %} {# Cualquier usuario autenticado puede activar si el equipo está inactivo o de baja #}
                    <a href="{% url 'core:activar_equipo' equipo.pk %}" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        <i class="fas fa-check-circle mr-2"></i> Activar Equipo
                    </a>
                    {% if equipo.estado == 'Inactivo' %}
                    {# Opcional: Permitir dar de baja desde Inactivo si se desea #}
                    <a href="{% url 'core:dar_baja_equipo' equipo.pk %}" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        <i class="fas fa-minus-circle mr-2"></i> Dar de Baja
                    </a>
                    {% endif %}
                {% endif %}
                {# === Fin Lógica de Botones de Estado === #}
                
                {# Botón para eliminar equipo (solo si tiene permiso) #}
                {% if perms.core.delete_equipo %}
                <button type="button" 
                        onclick="showDeleteModal('{% url 'core:eliminar_equipo' equipo.pk %}', '{{ equipo.nombre }}')" 
                        class="bg-red-600 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    Eliminar Equipo
                </button>
                {% endif %}
                <a href="{% url 'core:home' %}" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Volver al Listado
                </a>
            </div>
        </div>

        {# Mensajes de Django #}
        {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                    <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %} p-3 rounded-md shadow-sm mb-2" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {# Detalles del Equipo #}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
            <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Información General</h2>
                <p><strong>Código Interno:</strong> {{ equipo.codigo_interno }}</p>
                <p><strong>Nombre:</strong> {{ equipo.nombre }}</p>
                <p><strong>Empresa:</strong> {{ equipo.empresa.nombre|default:"N/A" }}</p>
                <p><strong>Tipo de Equipo:</strong> {{ equipo.get_tipo_equipo_display }}</p>
                <p><strong>Marca:</strong> {{ equipo.marca|default:"N/A" }}</p>
                <p><strong>Modelo:</strong> {{ equipo.modelo|default:"N/A" }}</p>
                <p><strong>Número de Serie:</strong> {{ equipo.numero_serie|default:"N/A" }}</p>
                <p><strong>Ubicación:</strong> {{ equipo.ubicacion|default:"N/A" }}</p>
                <p><strong>Responsable:</strong> {{ equipo.responsable|default:"N/A" }}</p>
                <p><strong>Estado:</strong> <span class="font-bold {% if equipo.estado == 'Activo' %}text-green-600{% elif equipo.estado == 'De Baja' %}text-red-600{% elif equipo.estado == 'Inactivo' %}text-yellow-600{% else %}text-gray-600{% endif %}">{{ equipo.estado }}</span></p>
                <p><strong>Fecha de Adquisición:</strong> {{ equipo.fecha_adquisicion|date:"Y-m-d"|default:"N/A" }}</p>
                <p><strong>Fecha de Registro:</strong> {{ equipo.fecha_registro|date:"Y-m-d"|default:"N/A" }}</p> {# CORRECCIÓN: Se eliminó el formato de hora #}
                <p><strong>Observaciones:</strong> {{ equipo.observaciones|default:"N/A" }}</p>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Especificaciones Técnicas</h2>
                <p><strong>Rango de Medida:</strong> {{ equipo.rango_medida|default:"N/A" }}</p>
                <p><strong>Resolución:</strong> {{ equipo.resolucion|default:"N/A" }}</p>
                <p><strong>Error Máximo Permisible:</strong> {{ equipo.error_maximo_permisible|default:"N/A" }}</p>
                <p><strong>Puntos de Calibración:</strong> {{ equipo.puntos_calibracion|default:"N/A"|linebreaksbr }}</p>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Información de Formato</h2>
                <p><strong>Versión del Formato:</strong> {{ equipo.version_formato|default:"N/A" }}</p>
                <p><strong>Fecha de Versión:</strong> {{ equipo.fecha_version_formato|date:"Y-m-d"|default:"N/A" }}</p>
                <p><strong>Codificación del Formato:</strong> {{ equipo.codificacion_formato|default:"N/A" }}</p>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Próximas Actividades</h2>
                <p><strong>Próxima Calibración:</strong> <span class="{{ equipo.proxima_calibracion_status }}">{{ equipo.proxima_calibracion|date:"Y-m-d"|default:"N/A" }}</span></p>
                <p><strong>Frecuencia Calibración:</strong> {{ equipo.frecuencia_calibracion_meses|default:"N/A" }} meses</p>
                <p><strong>Próximo Mantenimiento:</strong> <span class="{{ equipo.proximo_mantenimiento_status }}">{{ equipo.proximo_mantenimiento|date:"Y-m-d"|default:"N/A" }}</span></p>
                <p><strong>Frecuencia Mantenimiento:</strong> {{ equipo.frecuencia_mantenimiento_meses|default:"N/A" }} meses</p>
                <p><strong>Próxima Comprobación:</strong> <span class="{{ equipo.proxima_comprobacion_status }}">{{ equipo.proxima_comprobacion|date:"Y-m-d"|default:"N/A" }}</span></p>
                <p><strong>Frecuencia Comprobación:</strong> {{ equipo.frecuencia_comprobacion_meses|default:"N/A" }} meses</p>
            </div>

            {% equipo_imagen_url equipo as imagen_url %}
            {% if imagen_url %}
            <div class="bg-gray-50 p-4 rounded-lg shadow-sm md:col-span-2">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Imagen del Equipo</h2>
                <img src="{{ imagen_url }}" alt="Imagen de {{ equipo.nombre }}" class="max-w-full h-auto rounded-md shadow-md mx-auto"
                     loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div class="bg-gray-200 p-8 rounded-md text-center text-gray-500 mx-auto" style="display: none; max-width: 300px;">
                    <i class="fas fa-tools text-3xl mb-3"></i>
                    <p class="text-sm">Imagen del equipo no disponible</p>
                </div>
            </div>
            {% endif %}

            {# Documentos Asociados al Equipo #}
            <div class="bg-gray-50 p-4 rounded-lg shadow-sm md:col-span-2">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Documentos del Equipo</h2>
                <ul class="list-disc list-inside space-y-1">
                    {% if archivo_compra_pdf_url %}
                        <li><a href="{{ archivo_compra_pdf_url }}" target="_blank" class="text-blue-600 hover:underline"><i class="fas fa-file-pdf mr-2"></i> Archivo de Compra</a></li>
                    {% else %}
                        <li>Archivo de Compra: N/A</li>
                    {% endif %}
                    {% if equipo.ficha_tecnica_pdf %}
                        <li><a href="{{ equipo.ficha_tecnica_pdf.url }}" target="_blank" class="text-blue-600 hover:underline"><i class="fas fa-file-pdf mr-2"></i> Ficha Técnica</a></li>
                    {% else %}
                        <li>Ficha Técnica: N/A</li>
                    {% endif %}
                    {% if equipo.manual_pdf %}
                        <li><a href="{{ equipo.manual_pdf.url }}" target="_blank" class="text-blue-600 hover:underline"><i class="fas fa-file-pdf mr-2"></i> Manual</a></li>
                    {% else %}
                        <li>Manual: N/A</li>
                    {% endif %}
                    {% if equipo.otros_documentos_pdf %}
                        <li><a href="{{ equipo.otros_documentos_pdf.url }}" target="_blank" class="text-blue-600 hover:underline"><i class="fas fa-file-pdf mr-2"></i> Otros Documentos</a></li>
                    {% else %}
                        <li>Otros Documentos: N/A</li>
                    {% endif %}
                </ul>
            </div>
        </div>

        {# Información de Baja (Visible solo si el equipo tiene un registro de baja) #}
        {% if baja_registro %}
        <div class="mt-8 bg-red-50 border border-red-200 shadow-lg rounded-lg p-6 text-red-800">
            <h2 class="text-2xl font-bold text-red-800 mb-4 flex items-center">
                <i class="fas fa-exclamation-triangle mr-3 text-red-600"></i> Información de Baja
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="font-semibold">Razón de Baja:</p>
                    <p>{{ baja_registro.razon_baja|default:"N/A" }}</p>
                </div>
                <div>
                    <p class="font-semibold">Fecha de Baja:</p>
                    <p>{{ baja_registro.fecha_baja|date:"Y-m-d"|default:"N/A" }}</p>
                </div>
                <div>
                    <p class="font-semibold">Dado de Baja Por:</p>
                    <p>{{ baja_registro.dado_de_baja_por.get_full_name|default:baja_registro.dado_de_baja_por.username|default:"N/A" }}</p>
                </div>
                <div>
                    <p class="font-semibold">Observaciones Adicionales:</p>
                    <p>{{ baja_registro.observaciones|default:"N/A" }}</p>
                </div>
                {% if documento_baja_url %}
                <div class="md:col-span-2">
                    <p class="font-semibold">Documento de Baja:</p>
                    <a href="{{ documento_baja_url }}" target="_blank" class="text-blue-600 hover:underline flex items-center">
                        <i class="fas fa-file-pdf mr-2"></i> Ver Documento de Baja
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {# Historial de Calibraciones #}
        <div class="mt-8 bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Historial de Calibraciones</h2>
            <div class="flex justify-end mb-4 gap-2">
                {% if perms.core.add_calibracion %}
                <a href="{% url 'core:añadir_calibracion' equipo.pk %}" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-plus-circle mr-2"></i> Añadir Calibración
                </a>
                {% endif %}
            </div>
            {% if calibraciones %}
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">Fecha Calibración</th>
                            <th class="py-3 px-6 text-left">Proveedor</th>
                            <th class="py-3 px-6 text-left">Resultado</th>
                            <th class="py-3 px-6 text-left">Nº Certificado</th>
                            <th class="py-3 px-6 text-left">Próxima Actividad (este registro)</th>
                            <th class="py-3 px-6 text-left">Documentos</th>
                            <th class="py-3 px-6 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-sm">
                        {% for cal in calibraciones %}
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="py-3 px-6 text-left whitespace-nowrap">{{ cal.fecha_calibracion|date:"Y-m-d" }}</td>
                            <td class="py-3 px-6 text-left">{{ cal.nombre_proveedor|default:"N/A" }}</td> 
                            <td class="py-3 px-6 text-left">{{ cal.resultado }}</td>
                            <td class="py-3 px-6 text-left">{{ cal.numero_certificado|default:"N/A" }}</td>
                            <td class="py-3 px-6 text-left">
                                {% if cal.proxima_actividad_para_este_registro %}
                                    {{ cal.proxima_actividad_para_este_registro|date:"Y-m-d" }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="py-3 px-6 text-left">
                                <div class="flex flex-col space-y-1">
                                    {% if cal.documento_calibracion %}
                                        <a href="{{ cal.documento_calibracion.url }}" target="_blank" class="text-blue-600 hover:underline text-xs">
                                            <i class="fas fa-file-pdf mr-1"></i> Certificado
                                        </a>
                                    {% endif %}
                                    {% if cal.confirmacion_metrologica_pdf %}
                                        <a href="{{ cal.confirmacion_metrologica_pdf.url }}" target="_blank" class="text-green-600 hover:underline text-xs">
                                            <i class="fas fa-file-pdf mr-1"></i> Confirmación Metrológica
                                        </a>
                                    {% endif %}
                                    {% if cal.intervalos_calibracion_pdf %}
                                        <a href="{{ cal.intervalos_calibracion_pdf.url }}" target="_blank" class="text-purple-600 hover:underline text-xs">
                                            <i class="fas fa-file-pdf mr-1"></i> Intervalos de Calibración
                                        </a>
                                    {% endif %}
                                    {% if not cal.documento_calibracion and not cal.confirmacion_metrologica_pdf and not cal.intervalos_calibracion_pdf %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="py-3 px-6 text-center">
                                <div class="flex flex-col gap-2 items-center">
                                    {# Botones de Formatos Metrológicos #}
                                    <div class="flex gap-2">
                                        <a href="{% url 'core:confirmacion_metrologica' equipo.pk %}?calibracion_id={{ cal.pk }}"
                                           class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-1 px-2 rounded shadow transition"
                                           title="Generar Confirmación Metrológica">
                                            <i class="fas fa-clipboard-check"></i> Confirmación
                                        </a>
                                        <a href="{% url 'core:intervalos_calibracion' equipo.pk %}?calibracion_id={{ cal.pk }}"
                                           class="bg-purple-500 hover:bg-purple-600 text-white text-xs font-semibold py-1 px-2 rounded shadow transition"
                                           title="Calcular Intervalos de Calibración">
                                            <i class="fas fa-calendar-alt"></i> Intervalos
                                        </a>
                                    </div>

                                    {# Botones de Edición/Eliminación #}
                                    <div class="flex item-center justify-center gap-2">
                                        {% if perms.core.change_calibracion %}
                                        <a href="{% url 'core:editar_calibracion' equipo.pk cal.pk %}" class="w-4 transform hover:text-purple-500 hover:scale-110">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% endif %}
                                        {% if perms.core.delete_calibracion %}
                                        <button type="button"
                                                onclick="showDeleteModal('{% url 'core:eliminar_calibracion' equipo.pk cal.pk %}', 'calibración del {{ cal.fecha_calibracion|date:"Y-m-d" }}')"
                                                class="w-4 transform hover:text-purple-500 hover:scale-110">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-600">No hay calibraciones registradas para este equipo.</p>
            {% endif %}
        </div>

        {# Historial de Mantenimientos #}
        <div class="mt-8 bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Historial de Mantenimientos</h2>
            <div class="flex justify-end gap-3 mb-4">
                {% if perms.core.add_mantenimiento %}
                <a href="{% url 'core:mantenimiento_actividades' equipo.pk %}" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-tasks mr-2"></i> Mantenimiento con Actividades
                </a>
                <a href="{% url 'core:añadir_mantenimiento' equipo.pk %}" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-plus-circle mr-2"></i> Añadir Mantenimiento Simple
                </a>
                {% endif %}
            </div>
            {% if mantenimientos %}
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">Fecha Mantenimiento</th>
                            <th class="py-3 px-6 text-left">Tipo</th>
                            <th class="py-3 px-6 text-left">Proveedor</th>
                            <th class="py-3 px-6 text-left">Responsable</th>
                            <th class="py-3 px-6 text-left">Costo</th>
                            <th class="py-3 px-6 text-left">Próxima Actividad (este registro)</th>
                            <th class="py-3 px-6 text-left">Documento</th>
                            <th class="py-3 px-6 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-sm">
                        {% for mant in mantenimientos %}
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="py-3 px-6 text-left whitespace-nowrap">{{ mant.fecha_mantenimiento|date:"Y-m-d" }}</td>
                            <td class="py-3 px-6 text-left">{{ mant.get_tipo_mantenimiento_display }}</td>
                            <td class="py-3 px-6 text-left">{{ mant.nombre_proveedor|default:"N/A" }}</td> 
                            <td class="py-3 px-6 text-left">{{ mant.responsable|default:"N/A" }}</td>
                            <td class="py-3 px-6 text-left">${{ mant.costo|floatformat:2|default:"0.00" }}</td>
                            <td class="py-3 px-6 text-left">
                                {% if mant.proxima_actividad_para_este_registro %}
                                    {{ mant.proxima_actividad_para_este_registro|date:"Y-m-d" }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="py-3 px-6 text-left">
                                <div class="flex flex-col space-y-1">
                                    {% if mant.mantenimiento_pdf %}
                                        <a href="{{ mant.mantenimiento_pdf.url }}" target="_blank" class="text-blue-600 hover:underline text-xs font-semibold">
                                            <i class="fas fa-file-pdf mr-1"></i> PDF Mantenimiento
                                        </a>
                                    {% endif %}
                                    {% if mant.documento_externo %}
                                        <a href="{{ mant.documento_externo.url }}" target="_blank" class="text-blue-600 hover:underline text-xs">
                                            <i class="fas fa-file mr-1"></i> Doc. Externo
                                        </a>
                                    {% endif %}
                                    {% if mant.analisis_interno %}
                                        <a href="{{ mant.analisis_interno.url }}" target="_blank" class="text-green-600 hover:underline text-xs">
                                            <i class="fas fa-file-alt mr-1"></i> Análisis Int.
                                        </a>
                                    {% endif %}
                                    {% if mant.documento_mantenimiento %}
                                        <a href="{% url 'core:ver_archivo_mantenimiento' mant.pk %}" target="_blank" class="text-purple-600 hover:underline text-xs">
                                            <i class="fas fa-file-pdf mr-1"></i> Doc. General
                                        </a>
                                    {% endif %}
                                    {% if not mant.mantenimiento_pdf and not mant.documento_externo and not mant.analisis_interno and not mant.documento_mantenimiento %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="py-3 px-6 text-center">
                                <div class="flex item-center justify-center">
                                    {% if perms.core.change_mantenimiento %}
                                    <a href="{% url 'core:editar_mantenimiento' equipo.pk mant.pk %}" class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}
                                    {% if perms.core.delete_mantenimiento %}
                                    <button type="button" 
                                            onclick="showDeleteModal('{% url 'core:eliminar_mantenimiento' equipo.pk mant.pk %}', 'mantenimiento del {{ mant.fecha_mantenimiento|date:"Y-m-d" }}')" 
                                            class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-600">No hay mantenimientos registrados para este equipo.</p>
            {% endif %}
        </div>

        {# Historial de Comprobaciones #}
        <div class="mt-8 bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Historial de Comprobaciones</h2>
            <div class="flex justify-end mb-4">
                {% if perms.core.add_comprobacion %}
                <a href="{% url 'core:añadir_comprobacion' equipo.pk %}" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-plus-circle mr-2"></i> Añadir Comprobación
                </a>
                {% endif %}
            </div>
            {% if comprobaciones %}
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">Fecha Comprobación</th>
                            <th class="py-3 px-6 text-left">Proveedor</th>
                            <th class="py-3 px-6 text-left">Responsable</th>
                            <th class="py-3 px-6 text-left">Resultado</th>
                            <th class="py-3 px-6 text-left">Próxima Actividad (este registro)</th>
                            <th class="py-3 px-6 text-left">Documento</th>
                            <th class="py-3 px-6 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-sm">
                        {% for comp in comprobaciones %}
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="py-3 px-6 text-left whitespace-nowrap">{{ comp.fecha_comprobacion|date:"Y-m-d" }}</td>
                            <td class="py-3 px-6 text-left">{{ comp.nombre_proveedor|default:"N/A" }}</td> 
                            <td class="py-3 px-6 text-left">{{ comp.responsable|default:"N/A" }}</td>
                            <td class="py-3 px-6 text-left">{{ comp.resultado }}</td>
                            <td class="py-3 px-6 text-left">
                                {% if comp.proxima_actividad_para_este_registro %}
                                    {{ comp.proxima_actividad_para_este_registro|date:"Y-m-d" }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="py-3 px-6 text-left">
                                <div class="flex flex-col space-y-1">
                                    {% if comp.documento_externo %}
                                        <a href="{{ comp.documento_externo.url }}" target="_blank" class="text-blue-600 hover:underline text-xs">
                                            <i class="fas fa-file mr-1"></i> Doc. Externo
                                        </a>
                                    {% endif %}
                                    {% if comp.analisis_interno %}
                                        <a href="{{ comp.analisis_interno.url }}" target="_blank" class="text-green-600 hover:underline text-xs">
                                            <i class="fas fa-file-alt mr-1"></i> Análisis Int.
                                        </a>
                                    {% endif %}
                                    {% if comp.comprobacion_pdf %}
                                        <a href="{{ comp.comprobacion_pdf.url }}" target="_blank" class="text-blue-600 hover:underline text-xs">
                                            <i class="fas fa-file-pdf mr-1"></i> Comprobación Metrológica
                                        </a>
                                    {% endif %}
                                    {% if comp.documento_comprobacion %}
                                        <a href="{{ comp.documento_comprobacion.url }}" target="_blank" class="text-purple-600 hover:underline text-xs">
                                            <i class="fas fa-file-pdf mr-1"></i> Doc. General
                                        </a>
                                    {% endif %}
                                    {% if not comp.documento_externo and not comp.analisis_interno and not comp.documento_comprobacion and not comp.comprobacion_pdf %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="py-3 px-6 text-center">
                                <div class="flex item-center justify-center gap-2">
                                    <a href="{% url 'core:comprobacion_metrologica' equipo.pk %}?comprobacion_id={{ comp.pk }}"
                                       class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-1 px-2 rounded shadow transition"
                                       title="Comprobación Metrológica">
                                        <i class="fas fa-clipboard-check"></i>
                                    </a>
                                    {% if perms.core.change_comprobacion %}
                                    <a href="{% url 'core:editar_comprobacion' equipo.pk comp.pk %}" class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}
                                    {% if perms.core.delete_comprobacion %}
                                    <button type="button"
                                            onclick="showDeleteModal('{% url 'core:eliminar_comprobacion' equipo.pk comp.pk %}', 'comprobación del {{ comp.fecha_comprobacion|date:"Y-m-d" }}')"
                                            class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-600">No hay comprobaciones registradas para este equipo.</p>
            {% endif %}
        </div>

        {# Sección de Gráficas Históricas - Al Final #}
        <div class="mt-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">
                <i class="fas fa-chart-line mr-2 text-indigo-600"></i>
                Análisis Histórico
            </h2>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                {# Gráfica de Confirmaciones #}
                <div class="bg-white shadow-lg rounded-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-clipboard-check mr-2 text-blue-600"></i>
                        Confirmaciones Metrológicas
                    </h3>
                    {% if grafica_hist_confirmaciones %}
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 overflow-x-auto">
                            <div class="min-w-full" style="min-width: 400px;">
                                {{ grafica_hist_confirmaciones|safe }}
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-gray-600 bg-blue-50 p-2 rounded border-l-4 border-blue-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>Nota:</strong> Últimas 5 confirmaciones. Las barras (±) representan incertidumbre.
                        </div>
                    {% elif mensaje_confirmaciones %}
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
                            <i class="fas fa-chart-line text-blue-400 text-4xl mb-3"></i>
                            <p class="text-gray-700 text-sm">{{ mensaje_confirmaciones }}</p>
                        </div>
                    {% endif %}
                </div>

                {# Gráfica de Comprobaciones #}
                <div class="bg-white shadow-lg rounded-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-check-double mr-2 text-green-600"></i>
                        Comprobaciones Metrológicas
                    </h3>
                    {% if grafica_hist_comprobaciones %}
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 overflow-x-auto">
                            <div class="min-w-full" style="min-width: 400px;">
                                {{ grafica_hist_comprobaciones|safe }}
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-gray-600 bg-green-50 p-2 rounded border-l-4 border-green-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>Nota:</strong> Últimas 5 comprobaciones. Límites EMP del registro más reciente.
                        </div>
                    {% elif mensaje_comprobaciones %}
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                            <i class="fas fa-chart-line text-green-400 text-4xl mb-3"></i>
                            <p class="text-gray-700 text-sm">{{ mensaje_comprobaciones }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>

    {# Modal de Confirmación de Eliminación #}
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Confirmar Eliminación</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        ¿Estás seguro de que quieres eliminar <strong id="entityName" class="font-semibold text-gray-700"></strong>?
                        Esta acción no se puede deshacer.
                    </p>
                </div>
                <div class="items-center px-4 py-3">
                    <form id="deleteForm" method="post" action="">
                        {% csrf_token %}
                        <button type="submit" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                            Eliminar
                        </button>
                        <button type="button" onclick="hideDeleteModal()" class="mt-3 px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 sm:mt-0 sm:w-auto sm:text-sm">
                            Cancelar
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function showDeleteModal(deleteUrl, entityName) {
        document.getElementById('entityName').innerText = entityName;
        document.getElementById('deleteForm').action = deleteUrl;
        document.getElementById('deleteModal').classList.remove('hidden');
    }

    function hideDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
    }

    // Navegación con teclado (NUEVO 2025-11-19)
    {% if prev_equipo_id or next_equipo_id %}
    document.addEventListener('keydown', function(e) {
        // Ctrl + Flecha Izquierda = Anterior
        {% if prev_equipo_id %}
        if (e.ctrlKey && e.key === 'ArrowLeft') {
            e.preventDefault();
            window.location.href = '{% url "core:detalle_equipo" prev_equipo_id %}';
        }
        {% endif %}

        // Ctrl + Flecha Derecha = Siguiente
        {% if next_equipo_id %}
        if (e.ctrlKey && e.key === 'ArrowRight') {
            e.preventDefault();
            window.location.href = '{% url "core:detalle_equipo" next_equipo_id %}';
        }
        {% endif %}
    });
    {% endif %}
</script>
{% endblock %}

