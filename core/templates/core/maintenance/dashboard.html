{% extends "base.html" %}
{% load static %}

{% block title %}Sistema de Mantenimiento - SAM{% endblock %}

{% block extra_css %}
<style>
    .task-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        height: 100%;
    }
    .task-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .stat-card {
        border-left: 4px solid;
    }
    .stat-card.primary { border-left-color: #0d6efd; }
    .stat-card.success { border-left-color: #198754; }
    .stat-card.warning { border-left-color: #ffc107; }
    .stat-card.danger { border-left-color: #dc3545; }
    .stat-card.info { border-left-color: #0dcaf0; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-tools"></i> Sistema de Mantenimiento</h2>
            <p class="text-muted">Panel de administración y mantenimiento del sistema SAM</p>
        </div>
        <div class="col-md-4 text-end">
            <button type="submit" form="health-check-form" class="btn btn-success">
                <i class="bi bi-heart-pulse"></i> Verificar Sistema
            </button>
            <a href="{% url 'core:maintenance_task_list' %}" class="btn btn-outline-primary">
                <i class="bi bi-list-task"></i> Ver Historial
            </a>
        </div>
    </div>

    <!-- Form oculto para health check -->
    <form id="health-check-form" method="POST" action="{% url 'core:run_system_health_check' %}" style="display: none;">
        {% csrf_token %}
    </form>

    <!-- Estadísticas de Tareas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card info">
                <div class="card-body">
                    <h6 class="text-muted">Total Tareas</h6>
                    <h2>{{ total_tasks }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card warning">
                <div class="card-body">
                    <h6 class="text-muted">Pendientes</h6>
                    <h2>{{ pending_tasks }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card success">
                <div class="card-body">
                    <h6 class="text-muted">Completadas</h6>
                    <h2>{{ completed_tasks }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card danger">
                <div class="card-body">
                    <h6 class="text-muted">Fallidas</h6>
                    <h2>{{ failed_tasks }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Estado del Sistema -->
    {% if last_health_check %}
    <div class="card mb-4">
        <div class="card-header bg-{% if last_health_check.overall_status == 'healthy' %}success{% elif last_health_check.overall_status == 'warning' %}warning{% else %}danger{% endif %} text-white">
            <i class="bi bi-activity"></i> Estado del Sistema - {{ last_health_check.get_overall_status_display }}
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <strong>Base de Datos:</strong> {{ last_health_check.database_status }}
                    {% if last_health_check.database_response_time %}
                    <br><small class="text-muted">{{ last_health_check.database_response_time|floatformat:2 }}ms</small>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <strong>Cache:</strong> {{ last_health_check.cache_status }}
                    {% if last_health_check.cache_response_time %}
                    <br><small class="text-muted">{{ last_health_check.cache_response_time|floatformat:2 }}ms</small>
                    {% endif %}
                </div>
                <div class="col-md-2">
                    <strong>Empresas:</strong> {{ last_health_check.total_empresas }}
                </div>
                <div class="col-md-2">
                    <strong>Equipos:</strong> {{ last_health_check.total_equipos }}
                </div>
                <div class="col-md-2">
                    <strong>Usuarios:</strong> {{ last_health_check.total_usuarios }}
                </div>
            </div>
            <small class="text-muted d-block mt-2">
                Última verificación: {{ last_health_check.checked_at|date:"d/m/Y H:i" }}
            </small>
        </div>
    </div>
    {% endif %}

    <!-- Tareas Disponibles -->
    <h4 class="mb-3">Ejecutar Tareas de Mantenimiento</h4>
    <div class="row">
        {% for task in available_tasks %}
        <div class="col-md-4 col-lg-3 mb-3">
            <div class="card task-card border-{{ task.color }}" onclick="executeTask('{{ task.type }}')">
                <div class="card-body text-center">
                    <i class="bi bi-{{ task.icon }} text-{{ task.color }}" style="font-size: 2.5rem;"></i>
                    <h6 class="mt-2">{{ task.name }}</h6>
                    <p class="text-muted small">{{ task.description }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Tareas Recientes -->
    {% if recent_tasks %}
    <h4 class="mb-3 mt-4">Tareas Recientes</h4>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Creada por</th>
                    <th>Fecha</th>
                    <th>Duración</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for task in recent_tasks %}
                <tr>
                    <td>#{{ task.id }}</td>
                    <td>{{ task.get_task_type_display }}</td>
                    <td>
                        {% if task.status == 'completed' %}
                        <span class="badge bg-success">{{ task.get_status_display }}</span>
                        {% elif task.status == 'failed' %}
                        <span class="badge bg-danger">{{ task.get_status_display }}</span>
                        {% elif task.status == 'running' %}
                        <span class="badge bg-primary">{{ task.get_status_display }}</span>
                        {% else %}
                        <span class="badge bg-warning">{{ task.get_status_display }}</span>
                        {% endif %}
                    </td>
                    <td>{{ task.created_by.username|default:"Sistema" }}</td>
                    <td>{{ task.created_at|date:"d/m/Y H:i" }}</td>
                    <td>{{ task.get_duration_display }}</td>
                    <td>
                        <a href="{% url 'core:maintenance_task_detail' task.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye"></i> Ver
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<!-- Modal de Confirmación -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Ejecución</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de ejecutar la tarea: <strong id="taskName"></strong>?</p>
                <p class="text-muted small">Esta acción se ejecutará inmediatamente.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmExecute">Ejecutar</button>
            </div>
        </div>
    </div>
</div>

<form id="taskForm" method="POST" action="{% url 'core:create_maintenance_task' %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="task_type" id="taskType">
</form>
{% endblock %}

{% block extra_js %}
<script>
let selectedTaskType = '';
const taskNames = {
    'backup_db': 'Backup de Base de Datos',
    'clear_cache': 'Limpiar Cache',
    'cleanup_files': 'Limpiar Archivos Temporales',
    'check_system': 'Verificar Sistema',
    'run_tests': 'Ejecutar Tests',
    'collect_static': 'Recolectar Estáticos',
    'migrate_db': 'Aplicar Migraciones'
};

function executeTask(taskType) {
    selectedTaskType = taskType;
    document.getElementById('taskName').textContent = taskNames[taskType] || taskType;
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}

document.getElementById('confirmExecute').addEventListener('click', function() {
    document.getElementById('taskType').value = selectedTaskType;
    document.getElementById('taskForm').submit();
});

// Auto-refresh cada 10 segundos si hay tareas en ejecución
{% if running_tasks > 0 %}
setTimeout(function() {
    location.reload();
}, 10000);
{% endif %}
</script>
{% endblock %}
