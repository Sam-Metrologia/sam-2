# GitHub Action: Verificaci√≥n Mensual de Empresas Eliminadas
# Se ejecuta autom√°ticamente el primer d√≠a de cada mes
# NO ELIMINA NADA - Solo genera un reporte para revisi√≥n

name: Verificaci√≥n Mensual de Empresas Eliminadas

on:
  schedule:
    # Primer d√≠a de cada mes a las 2:00 AM Colombia (7:00 UTC)
    - cron: '0 7 1 * *'
  workflow_dispatch:  # Permite ejecuci√≥n manual

jobs:
  check-deleted-companies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Configurar Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          pip install django python-dotenv psycopg2-binary

      - name: Verificar empresas elegibles para eliminaci√≥n (DRY-RUN)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          echo "=== VERIFICACI√ìN DE EMPRESAS ELIMINADAS ==="
          echo "Fecha: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "NOTA: Esta es solo una verificaci√≥n. NO se eliminar√° nada."
          echo ""

          # Ejecutar comando en modo dry-run (sin --execute)
          if python manage.py cleanup_deleted_companies --days=180 > cleanup_report.txt 2>&1; then
            echo "‚úÖ Verificaci√≥n completada exitosamente"
          else
            echo "‚ö†Ô∏è Advertencia: Hubo un problema al ejecutar la verificaci√≥n"
            echo "Revisa los logs arriba para m√°s detalles"
          fi

          # Mostrar reporte (incluso si hubo error)
          if [ -f cleanup_report.txt ]; then
            echo ""
            echo "=== CONTENIDO DEL REPORTE ==="
            cat cleanup_report.txt
          else
            echo "‚ùå No se pudo generar el reporte"
          fi

      - name: Guardar reporte como artefacto
        uses: actions/upload-artifact@v3
        with:
          name: cleanup-report-${{ github.run_number }}
          path: cleanup_report.txt
          retention-days: 90

      - name: Mostrar resumen del reporte
        run: |
          echo ""
          echo "=== RESUMEN DEL REPORTE ==="
          echo ""
          cat cleanup_report.txt
          echo ""
          echo "=== INSTRUCCIONES ==="
          echo ""
          echo "üìÑ El reporte completo est√° guardado como artefacto en esta ejecuci√≥n"
          echo "üìã Para revisar el reporte:"
          echo "   1. Ve a la pesta√±a 'Summary' de esta ejecuci√≥n"
          echo "   2. Descarga el artefacto 'cleanup-report-${{ github.run_number }}'"
          echo ""
          echo "‚úÖ Si hay empresas para eliminar y est√°s de acuerdo:"
          echo "   1. Ve a: https://github.com/${{ github.repository }}/actions/workflows/cleanup-execute.yml"
          echo "   2. Click en 'Run workflow'"
          echo "   3. Escribe 'CONFIRMO' para autorizar"
          echo ""
          echo "‚ö†Ô∏è IMPORTANTE: Esta verificaci√≥n NO elimin√≥ nada"

      - name: Resumen
        if: always()
        run: |
          echo ""
          echo "‚úÖ Verificaci√≥n completada"
          echo "üìÑ Reporte guardado como artefacto"
          echo "üìã Issue creado para revisi√≥n"
          echo ""
          echo "üëâ Revisa el issue creado en GitHub para ver el reporte completo"
