# GitHub Action: VerificaciÃ³n Mensual de Empresas Eliminadas
# Se ejecuta automÃ¡ticamente el primer dÃ­a de cada mes
# NO ELIMINA NADA - Solo genera un reporte para revisiÃ³n

name: VerificaciÃ³n Mensual de Empresas Eliminadas

on:
  schedule:
    # Primer dÃ­a de cada mes a las 2:00 AM Colombia (7:00 UTC)
    - cron: '0 7 1 * *'
  workflow_dispatch:  # Permite ejecuciÃ³n manual

jobs:
  check-deleted-companies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: Configurar Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          pip install django python-dotenv

      - name: Verificar empresas elegibles para eliminaciÃ³n (DRY-RUN)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          echo "=== VERIFICACIÃ“N DE EMPRESAS ELIMINADAS ==="
          echo "Fecha: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "NOTA: Esta es solo una verificaciÃ³n. NO se eliminarÃ¡ nada."
          echo ""

          # Ejecutar comando en modo dry-run (sin --execute)
          python manage.py cleanup_deleted_companies --days=180 > cleanup_report.txt 2>&1 || true

          # Mostrar reporte
          cat cleanup_report.txt

      - name: Guardar reporte como artefacto
        uses: actions/upload-artifact@v3
        with:
          name: cleanup-report-${{ github.run_number }}
          path: cleanup_report.txt
          retention-days: 90

      - name: Crear Issue de RevisiÃ³n
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('cleanup_report.txt', 'utf8');
            const today = new Date().toISOString().split('T')[0];
            const nextMonth = new Date(new Date().setMonth(new Date().getMonth() + 1)).toISOString().split('T')[0];

            const issueBody = `## ğŸ” Reporte de Empresas Eliminadas

**Fecha:** ${today}

### ğŸ“Š Resumen:

\`\`\`
${report}
\`\`\`

---

### âœ… Acciones Requeridas:

1. **Revisa el reporte arriba** para ver quÃ© empresas serÃ­an eliminadas permanentemente
2. **Si estÃ¡s de acuerdo con eliminarlas:**
   - Ve a: [Actions â†’ Eliminar Empresas Confirmadas](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/cleanup-execute.yml)
   - Haz clic en "Run workflow"
   - Escribe "CONFIRMO" para autorizar

3. **Si NO quieres eliminar alguna empresa:**
   - Restaura la empresa desde el panel de administraciÃ³n Django
   - O espera al siguiente mes

---

### âš ï¸ Importante:

- Este reporte es **solo informativo**
- **NO se ha eliminado nada** automÃ¡ticamente
- Tienes **control total** sobre quÃ© se elimina
- Las empresas listadas tienen mÃ¡s de **180 dÃ­as (6 meses)** desde su eliminaciÃ³n

---

**PrÃ³xima verificaciÃ³n:** ${nextMonth}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“‹ RevisiÃ³n Mensual: Empresas Eliminadas (${today})`,
              body: issueBody,
              labels: ['automatico', 'limpieza-empresas', 'requiere-revision']
            });

      - name: Resumen
        if: always()
        run: |
          echo ""
          echo "âœ… VerificaciÃ³n completada"
          echo "ğŸ“„ Reporte guardado como artefacto"
          echo "ğŸ“‹ Issue creado para revisiÃ³n"
          echo ""
          echo "ğŸ‘‰ Revisa el issue creado en GitHub para ver el reporte completo"
