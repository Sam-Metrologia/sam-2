{% extends 'base.html' %}
{% load static custom_filters %}

{% block title %}Planes y Precios ‚Äî SAM Metrolog√≠a{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-6xl">

    <!-- Encabezado -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Elige tu Plan</h1>
        {% if estado_plan == "Per√≠odo de Prueba Activo" and dias_restantes is not None %}
            <p class="text-yellow-600 font-medium">
                Tu trial vence en <strong>{{ dias_restantes }} d√≠a{{ dias_restantes|pluralize }}</strong>.
                Activa tu plan para no perder el acceso.
            </p>
        {% elif estado_plan == "Per√≠odo de Prueba Expirado" or estado_plan == "Plan Expirado" or estado_plan == "Expirado" %}
            <p class="text-red-600 font-semibold">
                Tu acceso est√° restringido. Activa un plan para continuar usando SAM Metrolog√≠a.
            </p>
        {% else %}
            <p class="text-gray-500">Todos los planes incluyen <strong>3 usuarios base</strong> (1 t√©cnico ¬∑ 1 administrador ¬∑ 1 gerente). Agrega m√°s seg√∫n lo que necesites.</p>
        {% endif %}
    </div>

    <!-- Toggle Mensual / Anual -->
    <div class="flex justify-center mb-8">
        <div class="inline-flex items-center bg-gray-100 rounded-xl p-1 gap-1">
            <button id="btn-mensual" onclick="switchPeriodo('mensual')"
                class="px-5 py-2 rounded-lg text-sm font-semibold transition-all duration-200 bg-white text-blue-700 shadow">
                Mensual
            </button>
            <button id="btn-anual" onclick="switchPeriodo('anual')"
                class="px-5 py-2 rounded-lg text-sm font-semibold transition-all duration-200 text-gray-500 hover:text-gray-700">
                Anual
                <span class="ml-1 text-xs font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded-full">2 meses gratis</span>
            </button>
        </div>
    </div>

    <!-- Tarjetas de planes -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-10">
        {% for tier in tiers %}
        {% with m=tier.mensual a=tier.anual %}

        <!-- ‚îÄ‚îÄ MENSUAL ‚îÄ‚îÄ -->
        <div class="periodo-mensual {% if m.tier == 'Est√°ndar' %}bg-blue-50 border-2 border-blue-500 shadow-md{% else %}bg-white border border-gray-200 shadow-sm{% endif %} rounded-xl p-5 flex flex-col relative">
            {% if m.tier == 'Est√°ndar' %}
            <div class="absolute -top-3 left-1/2 -translate-x-1/2 whitespace-nowrap">
                <span class="bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">M√°s popular</span>
            </div>
            {% endif %}
            <div class="mb-4 {% if m.tier == 'Est√°ndar' %}mt-2{% endif %}">
                <span class="text-xs font-semibold uppercase tracking-wide {% if m.tier == 'Est√°ndar' %}text-blue-500{% else %}text-gray-400{% endif %}">{{ m.tier }}</span>
                <div class="mt-1 flex items-end gap-1">
                    <span class="text-3xl font-bold text-gray-900">{{ m.precio_total|cop }}</span>
                    <span class="text-gray-400 text-xs pb-1">/mes</span>
                </div>
                <p class="text-xs text-green-600 font-medium mt-0.5">IVA incluido</p>
            </div>
            <ul class="space-y-1.5 text-xs text-gray-600 mb-5 flex-1">
                <li class="flex items-center gap-1.5"><svg class="w-3.5 h-3.5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg><strong>3 usuarios base</strong> incluidos</li>
                <li class="flex items-center gap-1.5"><svg class="w-3.5 h-3.5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Hasta <strong>{{ m.equipos }}</strong> equipos</li>
                <li class="flex items-center gap-1.5"><svg class="w-3.5 h-3.5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>{% widthratio m.almacenamiento_mb 1024 1 %} GB almacenamiento</li>
                <li class="flex items-center gap-1.5"><svg class="w-3.5 h-3.5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Calibraciones, comprobaciones y mantenimientos</li>
                <li class="flex items-center gap-1.5"><svg class="w-3.5 h-3.5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Reportes PDF y Excel</li>
            </ul>
            <form method="post" action="{% url 'core:iniciar_pago' %}">
                {% csrf_token %}
                <input type="hidden" name="plan" value="{{ m.key }}">
                <button type="submit" class="w-full {% if m.tier == 'Est√°ndar' %}bg-blue-600 hover:bg-blue-700{% else %}bg-gray-700 hover:bg-gray-800{% endif %} text-white font-semibold py-2.5 px-4 rounded-lg text-sm transition duration-200">Activar Plan</button>
            </form>
        </div>

        <!-- ‚îÄ‚îÄ ANUAL ‚îÄ‚îÄ -->
        <div class="periodo-anual hidden {% if a.tier == 'Est√°ndar' %}bg-blue-50 border-2 border-blue-500 shadow-md{% else %}bg-white border border-gray-200 shadow-sm{% endif %} rounded-xl p-5 flex flex-col relative">
            {% if a.tier == 'Est√°ndar' %}
            <div class="absolute -top-3 left-1/2 -translate-x-1/2 whitespace-nowrap">
                <span class="bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">M√°s popular</span>
            </div>
            {% endif %}
            <div class="mb-4 {% if a.tier == 'Est√°ndar' %}mt-2{% endif %}">
                <span class="text-xs font-semibold uppercase tracking-wide {% if a.tier == 'Est√°ndar' %}text-blue-500{% else %}text-gray-400{% endif %}">{{ a.tier }}</span>
                <div class="mt-1 flex items-end gap-1">
                    <span class="text-3xl font-bold text-gray-900">{{ a.precio_total|cop }}</span>
                    <span class="text-gray-400 text-xs pb-1">/a√±o</span>
                </div>
                <p class="text-xs text-green-600 font-medium mt-0.5">IVA incluido</p>
                {% if a.ahorro_total %}<p class="text-xs text-green-700 font-bold mt-0.5">Ahorras {{ a.ahorro_total|cop }} vs mensual</p>{% endif %}
            </div>
            <ul class="space-y-1.5 text-xs text-gray-600 mb-5 flex-1">
                <li class="flex items-center gap-1.5"><svg class="w-3.5 h-3.5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg><strong>3 usuarios base</strong> incluidos</li>
                <li class="flex items-center gap-1.5"><svg class="w-3.5 h-3.5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Hasta <strong>{{ a.equipos }}</strong> equipos</li>
                <li class="flex items-center gap-1.5"><svg class="w-3.5 h-3.5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>{% widthratio a.almacenamiento_mb 1024 1 %} GB almacenamiento</li>
                <li class="flex items-center gap-1.5"><svg class="w-3.5 h-3.5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>12 meses de acceso continuo</li>
                <li class="flex items-center gap-1.5"><svg class="w-3.5 h-3.5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Calibraciones, comprobaciones y mantenimientos</li>
                <li class="flex items-center gap-1.5"><svg class="w-3.5 h-3.5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Reportes PDF y Excel</li>
            </ul>
            <form method="post" action="{% url 'core:iniciar_pago' %}">
                {% csrf_token %}
                <input type="hidden" name="plan" value="{{ a.key }}">
                <button type="submit" class="w-full {% if a.tier == 'Est√°ndar' %}bg-blue-600 hover:bg-blue-700{% else %}bg-gray-700 hover:bg-gray-800{% endif %} text-white font-semibold py-2.5 px-4 rounded-lg text-sm transition duration-200">Activar Plan</button>
            </form>
        </div>

        {% endwith %}
        {% endfor %}
    </div>

    <!-- ================================================================ -->
    <!-- CALCULADOR COMPLETO + SOLICITUD DE ADD-ONS                       -->
    <!-- ================================================================ -->
    <div class="mb-8" id="seccion-addons">
        <div class="text-center mb-5">
            <h2 class="text-xl font-bold text-gray-800">Arma exactamente lo que necesitas</h2>
            <p class="text-sm text-gray-500 mt-1">Todos los planes incluyen 3 usuarios base. Agrega m√°s seg√∫n tu operaci√≥n.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- ‚îÄ‚îÄ Panel izquierdo: calculador ‚îÄ‚îÄ -->
            <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm">
                <h3 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 11h.01M12 11h.01M15 11h.01M4 19h16a2 2 0 002-2V7a2 2 0 00-2-2H4a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    Calculador de add-ons
                </h3>

                <!-- Plan base del c√°lculo -->
                <div class="mb-4">
                    <label class="text-xs font-semibold text-gray-600 mb-1 block">Plan base que tendr√≠as</label>
                    <select id="calc-plan" onchange="calcularTotal()"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="95200:50">B√°sico ‚Äî $95.200/mes ¬∑ 50 equipos</option>
                        <option value="238000:200" selected>Est√°ndar ‚Äî $238.000/mes ¬∑ 200 equipos</option>
                        <option value="452200:500">Profesional ‚Äî $452.200/mes ¬∑ 500 equipos</option>
                        <option value="773500:1000">Empresarial ‚Äî $773.500/mes ¬∑ 1.000 equipos</option>
                    </select>
                </div>

                <div class="border-t border-gray-100 pt-4 mb-4">
                    <p class="text-xs font-semibold text-gray-500 uppercase mb-3">Usuarios adicionales</p>
                    <div class="space-y-3">

                        <!-- T√©cnico -->
                        <div class="flex items-center gap-3">
                            <span class="text-lg w-6 text-center">üë∑</span>
                            <div class="flex-1">
                                <div class="text-xs font-semibold text-gray-700">T√©cnico</div>
                                <div class="text-xs text-gray-400">Registra equipos y actividades ¬∑ <strong>$23.800/mes</strong> c/u</div>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <button onclick="cambiar('tecnico', -1)" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold text-sm flex items-center justify-center">‚àí</button>
                                <input type="number" id="calc-tecnico" value="0" min="0" max="99" oninput="calcularTotal()"
                                    class="w-12 text-center border border-gray-200 rounded-lg text-sm py-1 focus:outline-none focus:ring-1 focus:ring-blue-400">
                                <button onclick="cambiar('tecnico', 1)" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold text-sm flex items-center justify-center">+</button>
                            </div>
                        </div>

                        <!-- Admin -->
                        <div class="flex items-center gap-3">
                            <span class="text-lg w-6 text-center">üîß</span>
                            <div class="flex-1">
                                <div class="text-xs font-semibold text-gray-700">Administrador</div>
                                <div class="text-xs text-gray-400">Gestiona usuarios y configuraci√≥n ¬∑ <strong>$33.320/mes</strong> c/u</div>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <button onclick="cambiar('admin', -1)" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold text-sm flex items-center justify-center">‚àí</button>
                                <input type="number" id="calc-admin" value="0" min="0" max="99" oninput="calcularTotal()"
                                    class="w-12 text-center border border-gray-200 rounded-lg text-sm py-1 focus:outline-none focus:ring-1 focus:ring-blue-400">
                                <button onclick="cambiar('admin', 1)" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold text-sm flex items-center justify-center">+</button>
                            </div>
                        </div>

                        <!-- Gerente -->
                        <div class="flex items-center gap-3">
                            <span class="text-lg w-6 text-center">üëî</span>
                            <div class="flex-1">
                                <div class="text-xs font-semibold text-gray-700">Gerente</div>
                                <div class="text-xs text-gray-400">Dashboard, reportes y panel de decisiones ¬∑ <strong>$41.650/mes</strong> c/u</div>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <button onclick="cambiar('gerente', -1)" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold text-sm flex items-center justify-center">‚àí</button>
                                <input type="number" id="calc-gerente" value="0" min="0" max="99" oninput="calcularTotal()"
                                    class="w-12 text-center border border-gray-200 rounded-lg text-sm py-1 focus:outline-none focus:ring-1 focus:ring-blue-400">
                                <button onclick="cambiar('gerente', 1)" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold text-sm flex items-center justify-center">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-100 pt-4 mb-4">
                    <p class="text-xs font-semibold text-gray-500 uppercase mb-3">Recursos adicionales</p>
                    <div class="space-y-3">

                        <!-- Equipos extra -->
                        <div class="flex items-center gap-3">
                            <span class="text-lg w-6 text-center">‚öôÔ∏è</span>
                            <div class="flex-1">
                                <div class="text-xs font-semibold text-gray-700">Bloques de +50 equipos</div>
                                <div class="text-xs text-gray-400"><strong>$53.550/bloque/mes</strong> ¬∑ sin l√≠mite de bloques</div>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <button onclick="cambiar('equipos', -1)" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold text-sm flex items-center justify-center">‚àí</button>
                                <input type="number" id="calc-equipos" value="0" min="0" max="999" oninput="calcularTotal()"
                                    class="w-12 text-center border border-gray-200 rounded-lg text-sm py-1 focus:outline-none focus:ring-1 focus:ring-blue-400">
                                <button onclick="cambiar('equipos', 1)" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold text-sm flex items-center justify-center">+</button>
                            </div>
                        </div>

                        <!-- Storage extra -->
                        <div class="flex items-center gap-3">
                            <span class="text-lg w-6 text-center">üíæ</span>
                            <div class="flex-1">
                                <div class="text-xs font-semibold text-gray-700">Bloques de +5 GB</div>
                                <div class="text-xs text-gray-400"><strong>$23.800/bloque/mes</strong></div>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <button onclick="cambiar('storage', -1)" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold text-sm flex items-center justify-center">‚àí</button>
                                <input type="number" id="calc-storage" value="0" min="0" max="99" oninput="calcularTotal()"
                                    class="w-12 text-center border border-gray-200 rounded-lg text-sm py-1 focus:outline-none focus:ring-1 focus:ring-blue-400">
                                <button onclick="cambiar('storage', 1)" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold text-sm flex items-center justify-center">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resumen de totales -->
                <div id="resumen-total" class="bg-gray-50 rounded-lg p-3 text-sm space-y-1">
                    <!-- Llenado por JS -->
                </div>
            </div>

            <!-- ‚îÄ‚îÄ Panel derecho: resumen y solicitud ‚îÄ‚îÄ -->
            <div class="flex flex-col gap-4">

                <!-- Resumen del pedido -->
                <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm flex-1">
                    <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                        Tu resumen de add-ons
                    </h3>
                    <div id="resumen-pedido" class="text-sm text-gray-500 italic">
                        Ajusta las cantidades en el calculador.
                    </div>

                    <!-- Formulario de pago directo -->
                    <div id="btn-pago-container" class="mt-4 hidden">
                        <form id="form-addon-pago" method="post" action="{% url 'core:iniciar_addon_pago' %}">
                            {% csrf_token %}
                            <input type="hidden" name="tecnicos"        id="h-tecnicos"        value="0">
                            <input type="hidden" name="admins"          id="h-admins"          value="0">
                            <input type="hidden" name="gerentes"        id="h-gerentes"        value="0">
                            <input type="hidden" name="bloques_equipos" id="h-bloques_equipos" value="0">
                            <input type="hidden" name="bloques_storage" id="h-bloques_storage" value="0">
                            <button type="submit"
                                class="flex items-center justify-center gap-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-sm transition duration-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                                Pagar con PSE / Tarjeta
                            </button>
                        </form>
                        <p class="text-xs text-gray-400 text-center mt-2">
                            Los add-ons se activan autom√°ticamente al confirmar el pago.
                        </p>
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ Secci√≥n: qu√© pasa en mitad del plan ‚îÄ‚îÄ -->
                <div class="bg-amber-50 border border-amber-200 rounded-xl p-5">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <div>
                            <h4 class="text-sm font-bold text-amber-800 mb-2">¬øCompraste plan anual y necesitas m√°s a mitad del a√±o?</h4>
                            <div class="text-xs text-amber-700 space-y-1.5">
                                <p>‚úÖ <strong>Los add-ons son siempre mensuales</strong>, independiente de si tu plan base es anual.</p>
                                <p>‚úÖ Se activan desde el mes en que los solicitas y se cobran mensualmente.</p>
                                <p>‚úÖ Tu plan anual <strong>no se ve afectado</strong> ‚Äî solo agregas encima de √©l.</p>
                                <p>‚úÖ Al renovar el a√±o, puedes <strong>incluir los add-ons en el precio anual</strong> con el mismo descuento del 16.7%.</p>
                            </div>
                            <div class="mt-3 bg-white rounded-lg border border-amber-200 p-3 text-xs text-amber-900">
                                <strong>Ejemplo:</strong> Compraste Plan Est√°ndar Anual en enero. En julio necesitas 2 t√©cnicos m√°s y 100 equipos extra.<br>
                                ‚Üí Pagas $47.600 + $107.100 = <strong>$154.700/mes</strong> (IVA incluido) desde julio.<br>
                                ‚Üí En enero del a√±o siguiente, al renovar, lo incluyes todo en el precio anual.
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Tabla comparativa -->
    <div class="bg-white border border-gray-200 rounded-xl overflow-hidden mb-6">
        <div class="px-5 py-3 border-b border-gray-100 bg-gray-50">
            <h3 class="text-sm font-semibold text-gray-700">Comparaci√≥n de planes</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-gray-600">
                <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold">Caracter√≠stica</th>
                        <th class="px-4 py-3 text-center font-semibold">B√°sico</th>
                        <th class="px-4 py-3 text-center font-semibold bg-blue-50 text-blue-700">Est√°ndar</th>
                        <th class="px-4 py-3 text-center font-semibold">Profesional</th>
                        <th class="px-4 py-3 text-center font-semibold">Empresarial</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr><td class="px-4 py-3">Equipos base</td><td class="px-4 py-3 text-center">50</td><td class="px-4 py-3 text-center bg-blue-50 font-semibold text-blue-700">200</td><td class="px-4 py-3 text-center">500</td><td class="px-4 py-3 text-center">1.000</td></tr>
                    <tr class="bg-gray-50"><td class="px-4 py-3">Usuarios base</td><td class="px-4 py-3 text-center font-semibold text-green-700">3</td><td class="px-4 py-3 text-center bg-blue-50 font-semibold text-green-700">3</td><td class="px-4 py-3 text-center font-semibold text-green-700">3</td><td class="px-4 py-3 text-center font-semibold text-green-700">3</td></tr>
                    <tr><td class="px-4 py-3">Almacenamiento</td><td class="px-4 py-3 text-center">2 GB</td><td class="px-4 py-3 text-center bg-blue-50 text-blue-700">4 GB</td><td class="px-4 py-3 text-center">10 GB</td><td class="px-4 py-3 text-center">20 GB</td></tr>
                    <tr class="bg-gray-50"><td class="px-4 py-3 font-medium">Precio mensual</td><td class="px-4 py-3 text-center font-semibold">$95.200</td><td class="px-4 py-3 text-center bg-blue-50 font-bold text-blue-700">$238.000</td><td class="px-4 py-3 text-center font-semibold">$452.200</td><td class="px-4 py-3 text-center font-semibold">$773.500</td></tr>
                    <tr><td class="px-4 py-3 font-medium">Precio anual</td><td class="px-4 py-3 text-center font-semibold">$952.000</td><td class="px-4 py-3 text-center bg-blue-50 font-bold text-blue-700">$2.380.000</td><td class="px-4 py-3 text-center font-semibold">$4.522.000</td><td class="px-4 py-3 text-center font-semibold">$7.735.000</td></tr>
                    <tr class="bg-gray-50"><td class="px-4 py-3 text-green-700 font-medium">Ahorras al a√±o</td><td class="px-4 py-3 text-center text-green-700 font-semibold">$190.400</td><td class="px-4 py-3 text-center bg-blue-50 text-green-700 font-bold">$476.000</td><td class="px-4 py-3 text-center text-green-700 font-semibold">$904.400</td><td class="px-4 py-3 text-center text-green-700 font-semibold">$1.547.000</td></tr>
                </tbody>
            </table>
        </div>
        <div class="px-5 py-3 border-t border-gray-100 text-xs text-gray-400">
            Precios en COP ¬∑ IVA incluido ¬∑ Add-ons: T√©cnico $23.800 ¬∑ Admin $33.320 ¬∑ Gerente $41.650 ¬∑ +50 equipos $53.550 ¬∑ +5 GB $23.800 (por mes c/u, IVA incluido).
        </div>
    </div>

    <!-- Nota pasarela -->
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm text-gray-500 text-center mb-4">
        <p>
            <svg class="w-4 h-4 inline mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
            Pagos procesados de forma segura por <strong>Wompi</strong> (Bancolombia). SAM no almacena datos de tarjetas.
        </p>
        {% if wompi_sandbox %}<p class="mt-1 text-yellow-600 font-medium">Modo sandbox ‚Äî los pagos son de prueba</p>{% endif %}
    </div>

    <!-- Nota para clientes internacionales -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-700 text-center mb-4">
        <p>
            <svg class="w-4 h-4 inline mr-1 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"/></svg>
            <strong>¬øEst√°s fuera de Colombia?</strong>
            Wompi procesa pagos exclusivamente en Colombia (COP).
            Si est√°s en otro pa√≠s,
            <a href="https://wa.me/573247990534?text=Hola%2C%20soy%20cliente%20internacional%20y%20quiero%20contratar%20SAM%20Metrolog%C3%ADa"
               target="_blank" rel="noopener noreferrer"
               class="font-semibold underline hover:text-blue-900">escr√≠benos por WhatsApp</a>
            y gestionamos el pago de forma alternativa.
        </p>
    </div>

    <div class="text-center text-sm text-gray-400">
        ¬øTienes preguntas?
        <a href="https://wa.me/573247990534" target="_blank" rel="noopener noreferrer" class="text-green-600 hover:text-green-700 font-medium">Escr√≠benos por WhatsApp</a>
    </div>

</div>

<script>
// Precios "todo incluido" (IVA ya incluido en cada valor)
function cop(n) {
    return '$' + Math.round(n).toLocaleString('es-CO');
}

function cambiar(campo, delta) {
    const el = document.getElementById('calc-' + campo);
    el.value = Math.max(0, (parseInt(el.value) || 0) + delta);
    calcularTotal();
}

function calcularTotal() {
    const planSel    = document.getElementById('calc-plan').value.split(':');
    const planTotal  = parseInt(planSel[0]);   // ya incluye IVA
    const planEq     = parseInt(planSel[1]);
    const planNombre = document.getElementById('calc-plan').options[document.getElementById('calc-plan').selectedIndex].text.split(' ‚Äî ')[0];

    const tec  = Math.max(0, parseInt(document.getElementById('calc-tecnico').value)  || 0);
    const adm  = Math.max(0, parseInt(document.getElementById('calc-admin').value)    || 0);
    const ger  = Math.max(0, parseInt(document.getElementById('calc-gerente').value)  || 0);
    const bloq = Math.max(0, parseInt(document.getElementById('calc-equipos').value)  || 0);
    const stor = Math.max(0, parseInt(document.getElementById('calc-storage').value)  || 0);

    // Precios con IVA incluido
    const costoTec  = tec  * 23800;
    const costoAdm  = adm  * 33320;
    const costoGer  = ger  * 41650;
    const costoBloq = bloq * 53550;
    const costoStor = stor * 23800;

    const totalAddons = costoTec + costoAdm + costoGer + costoBloq + costoStor;
    const totalFinal  = planTotal + totalAddons;

    const hayAddons = totalAddons > 0;

    // ‚îÄ‚îÄ Resumen del total ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let htmlTotal = `<div class="flex justify-between text-gray-500">
        <span>Plan ${planNombre}</span><span>${cop(planTotal)}/mes</span></div>`;

    if (costoTec  > 0) htmlTotal += `<div class="flex justify-between text-gray-500"><span>üë∑ ${tec} t√©cnico${tec>1?'s':''}</span><span>${cop(costoTec)}/mes</span></div>`;
    if (costoAdm  > 0) htmlTotal += `<div class="flex justify-between text-gray-500"><span>üîß ${adm} admin${adm>1?'s':''}</span><span>${cop(costoAdm)}/mes</span></div>`;
    if (costoGer  > 0) htmlTotal += `<div class="flex justify-between text-gray-500"><span>üëî ${ger} gerente${ger>1?'s':''}</span><span>${cop(costoGer)}/mes</span></div>`;
    if (costoBloq > 0) htmlTotal += `<div class="flex justify-between text-gray-500"><span>‚öôÔ∏è ${bloq} bloque${bloq>1?'s':''} +${bloq*50} eq.</span><span>${cop(costoBloq)}/mes</span></div>`;
    if (costoStor > 0) htmlTotal += `<div class="flex justify-between text-gray-500"><span>üíæ ${stor} bloque${stor>1?'s':''} +${stor*5} GB</span><span>${cop(costoStor)}/mes</span></div>`;

    htmlTotal += `<div class="border-t border-gray-200 mt-2 pt-2 flex justify-between font-bold text-gray-800 text-sm"><span>Total mensual ¬∑ IVA incluido</span><span class="text-green-700">${cop(totalFinal)}/mes</span></div>`;

    if (bloq > 0) {
        htmlTotal += `<div class="mt-2 text-xs text-blue-600 bg-blue-50 rounded p-2">‚ÑπÔ∏è Equipos totales: ${planEq} (plan) + ${bloq*50} (add-ons) = <strong>${planEq + bloq*50}</strong></div>`;
    }

    document.getElementById('resumen-total').innerHTML = htmlTotal;

    // ‚îÄ‚îÄ Resumen del pedido (panel derecho) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let htmlPedido = '';
    if (!hayAddons) {
        htmlPedido = '<p class="text-gray-400 italic text-xs">Agrega usuarios o recursos en el calculador para ver el resumen.</p>';
        document.getElementById('btn-pago-container').classList.add('hidden');
    } else {
        htmlPedido = `<div class="space-y-2 text-xs">`;
        htmlPedido += `<div class="flex justify-between font-semibold text-gray-600 border-b pb-1 mb-1"><span>Add-on</span><span>$/mes</span></div>`;
        if (tec  > 0) htmlPedido += `<div class="flex justify-between"><span>üë∑ ${tec} T√©cnico${tec>1?'s':''} adicional${tec>1?'es':''}</span><span>${cop(costoTec)}</span></div>`;
        if (adm  > 0) htmlPedido += `<div class="flex justify-between"><span>üîß ${adm} Administrador${adm>1?'es':''} adicional${adm>1?'es':''}</span><span>${cop(costoAdm)}</span></div>`;
        if (ger  > 0) htmlPedido += `<div class="flex justify-between"><span>üëî ${ger} Gerente${ger>1?'s':''} adicional${ger>1?'es':''}</span><span>${cop(costoGer)}</span></div>`;
        if (bloq > 0) htmlPedido += `<div class="flex justify-between"><span>‚öôÔ∏è ${bloq} bloque${bloq>1?'s':''} de +50 equipos (= +${bloq*50} eq.)</span><span>${cop(costoBloq)}</span></div>`;
        if (stor > 0) htmlPedido += `<div class="flex justify-between"><span>üíæ ${stor} bloque${stor>1?'s':''} de +5 GB (= +${stor*5} GB)</span><span>${cop(costoStor)}</span></div>`;
        htmlPedido += `<div class="border-t pt-1 flex justify-between font-bold text-gray-700"><span>Total add-ons ¬∑ IVA incluido</span><span class="text-green-700">${cop(totalAddons)}/mes</span></div>`;
        htmlPedido += `</div>`;

        // Sincronizar hidden inputs del formulario con los valores del calculador
        document.getElementById('h-tecnicos').value        = tec;
        document.getElementById('h-admins').value          = adm;
        document.getElementById('h-gerentes').value        = ger;
        document.getElementById('h-bloques_equipos').value = bloq;
        document.getElementById('h-bloques_storage').value = stor;

        document.getElementById('btn-pago-container').classList.remove('hidden');
    }

    document.getElementById('resumen-pedido').innerHTML = htmlPedido;
}

function switchPeriodo(periodo) {
    document.querySelectorAll('.periodo-mensual').forEach(el => el.classList.toggle('hidden', periodo !== 'mensual'));
    document.querySelectorAll('.periodo-anual').forEach(el   => el.classList.toggle('hidden', periodo !== 'anual'));
    const btnM = document.getElementById('btn-mensual');
    const btnA = document.getElementById('btn-anual');
    if (periodo === 'mensual') {
        btnM.classList.add('bg-white','text-blue-700','shadow'); btnM.classList.remove('text-gray-500');
        btnA.classList.remove('bg-white','text-blue-700','shadow'); btnA.classList.add('text-gray-500');
    } else {
        btnA.classList.add('bg-white','text-blue-700','shadow'); btnA.classList.remove('text-gray-500');
        btnM.classList.remove('bg-white','text-blue-700','shadow'); btnM.classList.add('text-gray-500');
    }
}

document.addEventListener('DOMContentLoaded', calcularTotal);
</script>
{% endblock %}
