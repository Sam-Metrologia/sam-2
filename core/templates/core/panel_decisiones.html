{% extends 'base.html' %}
{% load static %}

{% block title %}{% if perspectiva == 'sam' %}Panel de Decisiones SAM - Vista Estrat√©gica{% else %}Panel de Decisiones - {{ empresa.nombre }}{% endif %}{% endblock %}

{% block extra_head %}
<style>
    /* ===== PANEL DECISIONES - DISE√ëO SIMPLIFICADO 3 ZONAS ===== */
    .pd-container {
        padding: 0;
    }

    /* --- HEADER --- */
    .pd-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
        color: white;
        padding: 18px 24px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    .pd-header h1 { font-size: 1.5rem; font-weight: bold; margin: 0; }
    .pd-header .pd-header-sub { font-size: 0.85rem; opacity: 0.8; margin: 4px 0 0 0; }
    .pd-header .pd-header-date { font-size: 0.8rem; opacity: 0.65; margin: 2px 0 0 0; }
    .pd-header select {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        background: rgba(255,255,255,0.9);
        color: #1f2937;
        font-size: 0.85rem;
    }

    /* --- ZONA 1: ESTADO RAPIDO (4 KPIs) --- */
    .pd-kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 14px;
        margin-bottom: 20px;
    }
    @media (max-width: 992px) {
        .pd-kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 576px) {
        .pd-kpi-grid { grid-template-columns: 1fr; }
    }
    .pd-kpi-card {
        background: var(--bg-card);
        border-radius: 10px;
        padding: 18px 16px;
        box-shadow: var(--shadow-sm);
        text-align: center;
        border: 1px solid var(--border-color);
        border-top: 4px solid var(--border-color);
        position: relative;
        cursor: default;
        transition: box-shadow 0.2s ease, transform 0.2s ease;
    }
    .pd-kpi-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
    }
    .pd-kpi-card .pd-kpi-value {
        font-size: 2.2rem;
        font-weight: bold;
        line-height: 1.1;
        margin-bottom: 4px;
    }
    .pd-kpi-card .pd-kpi-label {
        font-size: 0.78rem;
        color: var(--text-secondary);
        margin-bottom: 6px;
    }
    .pd-kpi-card .pd-kpi-sub {
        font-size: 0.72rem;
        color: var(--text-muted);
    }

    /* Colores de borde superior segun estado */
    .pd-kpi-card.kpi-green { border-top-color: #10b981; }
    .pd-kpi-card.kpi-blue { border-top-color: #3b82f6; }
    .pd-kpi-card.kpi-yellow { border-top-color: #f59e0b; }
    .pd-kpi-card.kpi-red { border-top-color: #ef4444; }

    /* --- BADGES DE ESTADO --- */
    .estado-badge {
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: bold;
        display: inline-block;
    }
    .badge-optimo, .badge-excelente { background: #d1fae5; color: #059669; }
    .badge-bueno { background: #dbeafe; color: #2563eb; }
    .badge-regular, .badge-en-riesgo { background: #fef3c7; color: #d97706; }
    .badge-critico, .badge-deficiente { background: #fed7d7; color: #dc2626; }

    /* Dark mode badges */
    [data-theme="dark"] .badge-optimo, [data-theme="dark"] .badge-excelente { background: rgba(16,185,129,0.2); color: #10b981; }
    [data-theme="dark"] .badge-bueno { background: rgba(59,130,246,0.2); color: #60a5fa; }
    [data-theme="dark"] .badge-regular, [data-theme="dark"] .badge-en-riesgo { background: rgba(251,191,36,0.2); color: #fbbf24; }
    [data-theme="dark"] .badge-critico, [data-theme="dark"] .badge-deficiente { background: rgba(239,68,68,0.2); color: #f87171; }

    /* Tooltip para formulas - expandido */
    .pd-formula-tip {
        color: var(--text-muted);
        font-size: 0.75rem;
        cursor: help;
        margin-left: 4px;
        position: relative;
        display: inline-block;
    }
    .pd-formula-tip .pd-tooltip-content {
        visibility: hidden;
        opacity: 0;
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-card);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px 14px;
        width: 280px;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        font-size: 0.72rem;
        line-height: 1.5;
        text-align: left;
        transition: opacity 0.2s, visibility 0.2s;
    }
    .pd-formula-tip .pd-tooltip-content::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -6px;
        border-width: 6px;
        border-style: solid;
        border-color: var(--border-color) transparent transparent transparent;
    }
    .pd-formula-tip:hover .pd-tooltip-content {
        visibility: visible;
        opacity: 1;
    }
    .pd-tooltip-title {
        font-weight: bold;
        color: var(--accent-primary);
        margin-bottom: 6px;
        font-size: 0.78rem;
    }
    .pd-tooltip-formula {
        background: var(--bg-tertiary);
        padding: 6px 8px;
        border-radius: 4px;
        margin: 6px 0;
        font-family: monospace;
        font-size: 0.7rem;
    }
    .pd-tooltip-list {
        margin: 6px 0;
        padding-left: 14px;
    }
    .pd-tooltip-list li {
        margin-bottom: 2px;
    }
    .pd-tooltip-example {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px dashed var(--border-color);
        color: var(--text-secondary);
        font-style: italic;
    }

    /* --- ZONA 2: REQUIERE ATENCION --- */
    .pd-attention {
        background: var(--bg-card);
        border-radius: 10px;
        padding: 20px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        margin-bottom: 20px;
    }
    .pd-attention h2 {
        font-size: 1.15rem;
        font-weight: bold;
        color: var(--text-primary);
        margin: 0 0 14px 0;
    }

    /* Sub-tabs de atencion */
    .pd-action-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 14px;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0;
    }
    .pd-action-tab {
        padding: 8px 14px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--text-secondary);
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .pd-action-tab:hover { color: var(--text-primary); }
    .pd-action-tab.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
    }
    .pd-action-tab .pd-badge-count {
        padding: 1px 7px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: bold;
        color: white;
    }
    .pd-badge-red { background: #ef4444; }
    .pd-badge-orange { background: #f59e0b; }
    .pd-badge-blue { background: #3b82f6; }

    .pd-action-panel { display: none; }
    .pd-action-panel.active { display: block; }

    /* Items de lista vencida/urgente */
    .pd-item-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        border-left: 3px solid #e5e7eb;
        margin-bottom: 6px;
        border-radius: 0 6px 6px 0;
        background: var(--bg-tertiary);
        font-size: 0.85rem;
    }
    .pd-item-row.item-vencido { border-left-color: #ef4444; }
    .pd-item-row.item-urgente { border-left-color: #f59e0b; }
    .pd-item-info { flex: 1; }
    .pd-item-info strong { color: var(--text-primary); }
    .pd-item-info small { color: var(--text-secondary); display: block; margin-top: 2px; }
    .pd-item-badge {
        font-size: 0.72rem;
        font-weight: bold;
        padding: 3px 8px;
        border-radius: 4px;
        white-space: nowrap;
        margin-left: 10px;
    }

    /* Items ocultos y bot√≥n Ver m√°s */
    .pd-item-hidden {
        display: none !important;
    }
    .pd-btn-ver-mas {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
        background: var(--bg-tertiary);
        border: 1px dashed var(--border-color);
        border-radius: 6px;
        color: var(--accent-primary);
        font-size: 0.82rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    .pd-btn-ver-mas:hover {
        background: var(--bg-secondary);
        border-color: var(--accent-primary);
    }
    .pd-btn-ver-mas i {
        transition: transform 0.2s;
    }
    .pd-btn-ver-mas[data-expanded="true"] i {
        transform: rotate(180deg);
    }

    /* Recomendaciones */
    .pd-rec-card {
        padding: 12px 14px;
        border-radius: 6px;
        margin-bottom: 8px;
        border-left: 3px solid;
    }
    .pd-rec-card.rec-critico { border-left-color: #ef4444; background: #fef2f2; }
    .pd-rec-card.rec-urgente { border-left-color: #f59e0b; background: #fffbeb; }
    .pd-rec-card.rec-importante { border-left-color: #3b82f6; background: #eff6ff; }
    .pd-rec-card.rec-mejora, .pd-rec-card.rec-estrategico, .pd-rec-card.rec-operativo, .pd-rec-card.rec-financiero { border-left-color: #10b981; background: #f0fdf4; }
    [data-theme="dark"] .pd-rec-card { background: rgba(255,255,255,0.05) !important; }

    /* --- ZONA 3: ANALISIS DETALLADO (TABS) --- */
    .pd-detail {
        background: var(--bg-card);
        border-radius: 10px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        margin-bottom: 20px;
        overflow: hidden;
    }
    .pd-tabs-bar {
        display: flex;
        gap: 0;
        border-bottom: 2px solid var(--border-color);
        overflow-x: auto;
        background: var(--bg-tertiary);
    }
    .pd-tab-btn {
        padding: 12px 18px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--text-secondary);
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        white-space: nowrap;
        transition: all 0.2s;
    }
    .pd-tab-btn:hover { color: var(--text-primary); background: rgba(59,130,246,0.05); }
    .pd-tab-btn.active {
        color: var(--accent-primary);
        border-bottom-color: var(--accent-primary);
        background: var(--bg-card);
    }
    .pd-tab-panel {
        display: none;
        padding: 20px 24px;
    }
    .pd-tab-panel.active { display: block; }

    /* Tarjetas de metricas dentro de tabs */
    .pd-metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 14px;
    }
    .pd-metric-card {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        text-align: center;
    }
    .pd-metric-card h4 {
        font-size: 0.85rem;
        font-weight: bold;
        color: var(--text-secondary);
        margin: 0 0 8px 0;
    }
    .pd-metric-card .pd-metric-value {
        font-size: 1.6rem;
        font-weight: bold;
        color: var(--text-primary);
    }
    .pd-metric-card .pd-metric-sub {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 4px;
    }

    /* Tarjeta de gradiente para metricas principales en tabs */
    .pd-gradient-card {
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        color: white;
    }
    .pd-gradient-green { background: linear-gradient(135deg, #059669, #10b981); }
    .pd-gradient-blue { background: linear-gradient(135deg, #1e40af, #3b82f6); }
    .pd-gradient-dark { background: linear-gradient(135deg, #0f172a, #1e293b); }

    /* Tabla comparativa por empresa (SAM) */
    .pd-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }
    .pd-table th {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        padding: 10px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.78rem;
        border-bottom: 2px solid var(--border-color);
    }
    .pd-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
    }
    .pd-table tr:hover td { background: rgba(59,130,246,0.04); }

    /* Grafico canvas */
    .pd-chart-container {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        margin-top: 14px;
    }

    /* Footer compacto */
    .pd-footer {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        padding: 14px;
        border-radius: 10px;
        text-align: center;
        font-size: 0.8rem;
        border: 1px solid var(--border-color);
    }

    /* Dark mode overrides - usa variables de themes.css que ya cambian en dark */
    [data-theme="dark"] .pd-kpi-card,
    [data-theme="dark"] .pd-attention,
    [data-theme="dark"] .pd-detail { background: var(--bg-card) !important; border-color: var(--border-color) !important; }
    [data-theme="dark"] .pd-tabs-bar { background: var(--bg-secondary) !important; }
    [data-theme="dark"] .pd-metric-card { background: var(--bg-secondary) !important; border-color: var(--border-color) !important; }
    [data-theme="dark"] .pd-item-row { background: var(--bg-secondary) !important; }
    [data-theme="dark"] .pd-table th { background: var(--bg-tertiary) !important; }
    [data-theme="dark"] .pd-chart-container { background: var(--bg-secondary) !important; border-color: var(--border-color) !important; }
    [data-theme="dark"] .pd-rec-card { background: var(--bg-secondary) !important; }
    [data-theme="dark"] .pd-footer { background: var(--bg-secondary) !important; border: 1px solid var(--border-color); }

    /* Boton de detalle equipos */
    .pd-btn-detail {
        padding: 6px 14px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.78rem;
        font-weight: 500;
        transition: background 0.2s;
        margin-top: 6px;
    }
    .pd-btn-detail:hover { background: #2563eb; }

    /* Estado OK vacio */
    .pd-empty-state {
        text-align: center;
        padding: 30px;
        color: var(--text-secondary);
    }
    .pd-empty-state i { font-size: 2rem; color: #10b981; display: block; margin-bottom: 8px; }
</style>
{% endblock %}

{% block content %}
<div class="pd-container">

{% if error %}
<div style="background: #fee2e2; color: #dc2626; padding: 20px; border-radius: 10px;">
    <h2 style="margin: 0; font-size: 1.3rem;">{{ error }}</h2>
</div>
{% else %}

<!-- ============================================================ -->
<!-- HEADER COMPACTO                                               -->
<!-- ============================================================ -->
<div class="pd-header">
    <div>
        <h1>
            {% if perspectiva == 'sam' %}
                Panel de Decisiones SAM
            {% else %}
                Panel de Decisiones
            {% endif %}
        </h1>
        <p class="pd-header-sub">
            {% if perspectiva == 'sam' %}
                Vista Estrat√©gica Multi-Empresa
                {% if selected_company_id %}
                    {% for emp in empresas_disponibles %}
                        {% if emp.id|stringformat:"s" == selected_company_id %}({{ emp.nombre }}){% endif %}
                    {% endfor %}
                {% endif %}
            {% else %}
                {{ empresa.nombre }}
            {% endif %}
        </p>
        <p class="pd-header-date">{{ today|date:"d M Y" }}</p>
    </div>

    {% if perspectiva == 'sam' %}
    <form method="get">
        <select name="empresa_id" onchange="this.form.submit()">
            <option value="">Todas las empresas</option>
            {% for emp in empresas_disponibles %}
                <option value="{{ emp.id }}" {% if selected_company_id == emp.id|stringformat:"s" %}selected{% endif %}>{{ emp.nombre }}</option>
            {% endfor %}
        </select>
    </form>
    {% endif %}
</div>

<!-- ============================================================ -->
<!-- ZONA 1: ESTADO RAPIDO (4 KPIs)                                -->
<!-- ============================================================ -->
<div class="pd-kpi-grid">

    <!-- KPI 1: Salud -->
    <div class="pd-kpi-card {% if salud_general_porcentaje >= 80 %}kpi-green{% elif salud_general_porcentaje >= 60 %}kpi-blue{% elif salud_general_porcentaje >= 40 %}kpi-yellow{% else %}kpi-red{% endif %}" style="cursor: pointer;" onclick="verDetallesEquiposSalud()">
        <div class="pd-kpi-value" style="color: {% if salud_general_porcentaje >= 80 %}#059669{% elif salud_general_porcentaje >= 60 %}#2563eb{% elif salud_general_porcentaje >= 40 %}#d97706{% else %}#dc2626{% endif %};">
            {{ salud_general_porcentaje }}%
        </div>
        <div class="pd-kpi-label">Salud de Equipos
            <span class="pd-formula-tip">
                <i class="fas fa-question-circle"></i>
                <div class="pd-tooltip-content">
                    <div class="pd-tooltip-title">F√≥rmula: Salud del Equipo</div>
                    <div class="pd-tooltip-formula">(Estado√ó30% + Cal√ó25% + Mant√ó25% + Comp√ó20%)</div>
                    <ul class="pd-tooltip-list">
                        <li>Estado Activo/Operativo = 100 pts</li>
                        <li>Calibraci√≥n Vigente = 100 pts</li>
                        <li>Mantenimiento Vigente = 100 pts</li>
                        <li>Comprobaci√≥n Vigente = 100 pts</li>
                    </ul>
                    <div class="pd-tooltip-example">Ej: (80√ó30% + 90√ó25% + 85√ó25% + 70√ó20%) = 81.75%</div>
                </div>
            </span>
        </div>
        <span class="estado-badge badge-{% if salud_general_estado == '√ìPTIMO' %}optimo{% elif salud_general_estado == 'BUENO' %}bueno{% elif salud_general_estado == 'EN RIESGO' %}en-riesgo{% else %}critico{% endif %}">{{ salud_general_estado }}</span>
        <div class="pd-kpi-sub" style="margin-top: 6px;">
            {% if perspectiva == 'sam' %}{{ equipos_saludables_total|default:equipos_saludables }}{% else %}{{ equipos_saludables }}{% endif %} de {% if perspectiva == 'sam' %}{{ total_equipos_gestionados|default:total_equipos_salud }}{% else %}{{ total_equipos_salud }}{% endif %} equipos
        </div>
    </div>

    <!-- KPI 2: Cumplimiento -->
    <div class="pd-kpi-card {% if cumplimiento_porcentaje >= 90 %}kpi-green{% elif cumplimiento_porcentaje >= 80 %}kpi-blue{% elif cumplimiento_porcentaje >= 70 %}kpi-yellow{% else %}kpi-red{% endif %}">
        <div class="pd-kpi-value" style="color: {% if cumplimiento_porcentaje >= 90 %}#059669{% elif cumplimiento_porcentaje >= 80 %}#2563eb{% elif cumplimiento_porcentaje >= 70 %}#d97706{% else %}#dc2626{% endif %};">
            {{ cumplimiento_porcentaje }}%
        </div>
        <div class="pd-kpi-label">Cumplimiento
            <span class="pd-formula-tip">
                <i class="fas fa-question-circle"></i>
                <div class="pd-tooltip-content">
                    <div class="pd-tooltip-title">F√≥rmula: Cumplimiento</div>
                    <div class="pd-tooltip-formula">(Realizadas √∑ Programadas) √ó 100</div>
                    <ul class="pd-tooltip-list">
                        <li>Cuenta calibraciones del a√±o</li>
                        <li>Cuenta mantenimientos del a√±o</li>
                        <li>Cuenta comprobaciones del a√±o</li>
                    </ul>
                    <div class="pd-tooltip-example">Ej: 45 realizadas de 60 programadas = 75%</div>
                </div>
            </span>
        </div>
        <span class="estado-badge badge-{% if cumplimiento_estado == 'EXCELENTE' %}excelente{% elif cumplimiento_estado == 'BUENO' %}bueno{% elif cumplimiento_estado == 'REGULAR' %}regular{% else %}deficiente{% endif %}">{{ cumplimiento_estado }}</span>
        <div class="pd-kpi-sub" style="margin-top: 6px;">
            {{ actividades_realizadas }} de {{ actividades_programadas }} actividades
        </div>
    </div>

    <!-- KPI 3: Eficiencia -->
    <div class="pd-kpi-card {% if eficiencia_porcentaje >= 95 %}kpi-green{% elif eficiencia_porcentaje >= 85 %}kpi-blue{% elif eficiencia_porcentaje >= 70 %}kpi-yellow{% else %}kpi-red{% endif %}">
        <div class="pd-kpi-value" style="color: {% if eficiencia_porcentaje >= 95 %}#059669{% elif eficiencia_porcentaje >= 85 %}#2563eb{% elif eficiencia_porcentaje >= 70 %}#d97706{% else %}#dc2626{% endif %};">
            {{ eficiencia_porcentaje }}%
        </div>
        <div class="pd-kpi-label">Eficiencia Operacional
            <span class="pd-formula-tip">
                <i class="fas fa-question-circle"></i>
                <div class="pd-tooltip-content">
                    <div class="pd-tooltip-title">F√≥rmula: Eficiencia</div>
                    <div class="pd-tooltip-formula">(Disponibles √∑ Total) √ó 100</div>
                    <ul class="pd-tooltip-list">
                        <li>Disponibles = Activo u Operativo</li>
                        <li>Excluye: De Baja e Inactivos</li>
                    </ul>
                    <div class="pd-tooltip-example">Ej: 95 disponibles de 100 total = 95%</div>
                </div>
            </span>
        </div>
        <span class="estado-badge badge-{% if eficiencia_estado == '√ìPTIMO' %}optimo{% elif eficiencia_estado == 'BUENO' %}bueno{% elif eficiencia_estado == 'REGULAR' %}regular{% else %}deficiente{% endif %}">{{ eficiencia_estado }}</span>
        <div class="pd-kpi-sub" style="margin-top: 6px;">
            {{ equipos_disponibles }} de {{ total_equipos_eficiencia|default:total_equipos_salud }} disponibles
        </div>
    </div>

    <!-- KPI 4: Alertas -->
    <div class="pd-kpi-card {% if total_vencidas > 0 %}kpi-red{% elif total_urgentes > 0 %}kpi-yellow{% else %}kpi-green{% endif %}">
        <div class="pd-kpi-value" style="color: {% if total_vencidas > 0 %}#dc2626{% elif total_urgentes > 0 %}#d97706{% else %}#059669{% endif %};">
            {{ total_vencidas|add:total_urgentes }}
        </div>
        <div class="pd-kpi-label">Alertas</div>
        {% if total_vencidas > 0 %}
            <span class="estado-badge badge-critico">{{ total_vencidas }} vencida{{ total_vencidas|pluralize:"s" }}</span>
        {% endif %}
        {% if total_urgentes > 0 %}
            <span class="estado-badge badge-en-riesgo" style="margin-left: 4px;">{{ total_urgentes }} urgente{{ total_urgentes|pluralize:"s" }}</span>
        {% endif %}
        {% if total_vencidas == 0 and total_urgentes == 0 %}
            <span class="estado-badge badge-optimo">TODO AL D√çA</span>
        {% endif %}
        <div class="pd-kpi-sub" style="margin-top: 6px;">Pr√≥ximos 7 d√≠as</div>
    </div>
</div>

<!-- ============================================================ -->
<!-- ZONA 2: REQUIERE TU ATENCI√ìN                                  -->
<!-- ============================================================ -->
<div class="pd-attention">
    <h2>Requiere tu Atenci√≥n</h2>

    <div class="pd-action-tabs">
        <button class="pd-action-tab active" onclick="switchActionTab('vencidas')">
            Vencidas <span class="pd-badge-count pd-badge-red">{{ total_vencidas }}</span>
        </button>
        <button class="pd-action-tab" onclick="switchActionTab('urgentes')">
            Urgentes 7d <span class="pd-badge-count pd-badge-orange">{{ total_urgentes }}</span>
        </button>
        <button class="pd-action-tab" onclick="switchActionTab('recomendaciones')">
            Recomendaciones <span class="pd-badge-count pd-badge-blue">{% if perspectiva == 'sam' %}{{ recomendaciones_sam|length|default:"0" }}{% else %}{{ recomendaciones|length|default:"0" }}{% endif %}</span>
        </button>
    </div>

    <!-- Panel: Vencidas -->
    <div id="action-vencidas" class="pd-action-panel active">
        {% if items_vencidos %}
            {% for item in items_vencidos %}
            <div class="pd-item-row item-vencido {% if forloop.counter > 5 %}pd-item-hidden{% endif %}" data-list="vencidas">
                <div class="pd-item-info">
                    <strong>{{ item.codigo }}</strong>: {{ item.nombre }}
                    <small>{{ item.tipo }} - Venci√≥: {{ item.fecha|date:"d/m/Y" }}{% if perspectiva == 'sam' and item.empresa %} | {{ item.empresa }}{% endif %}</small>
                </div>
                <div class="pd-item-badge" style="background: #fee2e2; color: #dc2626;">
                    {{ item.dias_atraso }} d√≠as
                </div>
            </div>
            {% endfor %}
            {% if items_vencidos|length > 5 %}
            <button class="pd-btn-ver-mas" onclick="toggleListItems('vencidas', this)" data-expanded="false">
                <i class="fas fa-chevron-down"></i> Ver todos ({{ items_vencidos|length }})
            </button>
            {% endif %}
        {% else %}
            <div class="pd-empty-state">
                <i class="fas fa-check-circle"></i>
                No hay actividades vencidas
            </div>
        {% endif %}
    </div>

    <!-- Panel: Urgentes -->
    <div id="action-urgentes" class="pd-action-panel">
        {% if items_urgentes %}
            {% for item in items_urgentes %}
            <div class="pd-item-row item-urgente {% if forloop.counter > 5 %}pd-item-hidden{% endif %}" data-list="urgentes">
                <div class="pd-item-info">
                    <strong>{{ item.codigo }}</strong>: {{ item.nombre }}
                    <small>{{ item.tipo }} - Vence: {{ item.fecha|date:"d/m/Y" }}{% if perspectiva == 'sam' and item.empresa %} | {{ item.empresa }}{% endif %}</small>
                </div>
                <div class="pd-item-badge" style="background: #fef3c7; color: #d97706;">
                    {{ item.dias_restantes }}d
                </div>
            </div>
            {% endfor %}
            {% if items_urgentes|length > 5 %}
            <button class="pd-btn-ver-mas" onclick="toggleListItems('urgentes', this)" data-expanded="false">
                <i class="fas fa-chevron-down"></i> Ver todos ({{ items_urgentes|length }})
            </button>
            {% endif %}
        {% else %}
            <div class="pd-empty-state">
                <i class="fas fa-check-circle"></i>
                No hay actividades urgentes en los pr√≥ximos 7 d√≠as
            </div>
        {% endif %}
    </div>

    <!-- Panel: Recomendaciones -->
    <div id="action-recomendaciones" class="pd-action-panel">
        {% for rec in recomendaciones %}
        <div class="pd-rec-card rec-{{ rec.tipo|lower }}">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                <strong style="font-size: 0.9rem; color: var(--text-primary);">{{ rec.titulo }}</strong>
                <span style="font-size: 0.68rem; font-weight: bold; padding: 2px 6px; border-radius: 4px; color: white; background: {% if rec.tipo == 'CR√çTICO' %}#dc2626{% elif rec.tipo == 'URGENTE' %}#d97706{% elif rec.tipo == 'IMPORTANTE' %}#2563eb{% else %}#059669{% endif %};">{{ rec.tipo }}</span>
            </div>
            <div style="font-size: 0.82rem; color: var(--text-secondary); margin-bottom: 4px;">{{ rec.descripcion }}</div>
            <div style="font-size: 0.8rem; font-weight: 600; color: var(--text-primary);">Acci√≥n: {{ rec.accion }}</div>
        </div>
        {% empty %}
        <div class="pd-empty-state">
            <i class="fas fa-check-circle"></i>
            No hay recomendaciones pendientes
        </div>
        {% endfor %}
    </div>
</div>

<!-- ============================================================ -->
<!-- ZONA 3: AN√ÅLISIS DETALLADO (TABS)                             -->
<!-- ============================================================ -->
<div class="pd-detail">

    {% if perspectiva == 'empresa' %}
    <!-- =================== TABS EMPRESA =================== -->
    <div class="pd-tabs-bar">
        <button class="pd-tab-btn active" onclick="switchTab('detail', 'financiero')">Financiero</button>
        <button class="pd-tab-btn" onclick="switchTab('detail', 'tendencias')">Tendencias</button>
        <button class="pd-tab-btn" onclick="switchTab('detail', 'conformidad')">Conformidad</button>
        <button class="pd-tab-btn" onclick="switchTab('detail', 'optimizacion')">Optimizaci√≥n</button>
    </div>

    <!-- Tab: Financiero -->
    <div id="detail-financiero" class="pd-tab-panel active">
        <div class="pd-metric-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 16px;">
            <div class="pd-metric-card">
                <h4>Gasto YTD {{ current_year }}</h4>
                <div class="pd-metric-value" style="color: #2563eb;">${{ gasto_ytd_total|floatformat:0 }}</div>
                <div class="pd-metric-sub">COP | Enero-{{ today|date:"M" }}</div>
                <div style="margin-top: 8px; font-size: 0.72rem; color: var(--text-muted);">
                    Cal: ${{ costos_calibracion_ytd|floatformat:0 }} ({{ porcentaje_calibracion }}%)
                    | Mant: ${{ costos_mantenimiento_ytd|floatformat:0 }} ({{ porcentaje_mantenimiento }}%)
                    | Comp: ${{ costos_comprobacion_ytd|floatformat:0 }} ({{ porcentaje_comprobacion }}%)
                </div>
            </div>
            <div class="pd-metric-card">
                <h4>Proyecci√≥n {{ formula_presupuesto.a√±o_proyeccion }}</h4>
                <div class="pd-metric-value" style="color: #7c3aed;">${{ proyeccion_gasto_proximo_a√±o|floatformat:0 }}</div>
                <div class="pd-metric-sub">COP | {{ actividades_proyectadas_total }} actividades</div>
                <div style="margin-top: 8px;">
                    <form method="get" style="display: inline;">
                        <select name="a√±o_proyeccion" onchange="this.form.submit()" style="font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border-color);">
                            {% for i in "12345"|make_list %}
                                {% with a√±o=current_year|add:forloop.counter0 %}
                                    <option value="{{ a√±o }}" {% if a√±o == formula_presupuesto.a√±o_proyeccion %}selected{% endif %}>{{ a√±o }}</option>
                                {% endwith %}
                            {% endfor %}
                        </select>
                    </form>
                </div>
            </div>
            <div class="pd-metric-card">
                <h4>Variaci√≥n Proyectada</h4>
                {% if gasto_ytd_total > 0 %}
                    {% widthratio proyeccion_gasto_proximo_a√±o gasto_ytd_total 100 as variacion %}
                    <div class="pd-metric-value" style="color: {% if variacion >= 110 %}#d97706{% elif variacion <= 90 %}#059669{% else %}#6b7280{% endif %};">
                        {% if variacion >= 110 %}+{{ variacion|add:"-100" }}%{% elif variacion <= 90 %}{{ variacion|add:"-100" }}%{% else %}~0%{% endif %}
                    </div>
                    <div class="pd-metric-sub">{% if variacion >= 110 %}Incremento{% elif variacion <= 90 %}Reducci√≥n{% else %}Estable{% endif %}</div>
                {% else %}
                    <div class="pd-metric-value" style="color: #9ca3af;">N/A</div>
                    <div class="pd-metric-sub">Sin datos hist√≥ricos</div>
                {% endif %}
            </div>
        </div>
        <div style="text-align: center;">
            <a id="exportar-excel-btn" href="{% url 'core:exportar_analisis_financiero' %}?a√±o_proyeccion={{ formula_presupuesto.a√±o_proyeccion }}" class="pd-btn-detail">
                <i class="fas fa-file-excel"></i> Exportar a Excel
            </a>
        </div>
    </div>

    <!-- Tab: Tendencias -->
    <div id="detail-tendencias" class="pd-tab-panel">
        <!-- NUEVA SECCI√ìN: Presupuesto vs Ejecuci√≥n -->
        <h4 style="font-size: 1rem; font-weight: bold; color: var(--text-primary); margin: 0 0 16px 0;">
            <i class="fas fa-chart-line" style="color: #3b82f6; margin-right: 8px;"></i>Presupuesto vs Ejecuci√≥n {{ current_year }}
        </h4>

        <!-- Gr√°fica de l√≠neas con √°rea -->
        <div class="pd-chart-container" style="margin-bottom: 20px;">
            <canvas id="presupuestoVsEjecucionChart" style="max-height: 280px;"></canvas>
        </div>

        <!-- 4 Tarjetas de Meses -->
        {% if meses_tarjetas %}
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
            {% for mes in meses_tarjetas %}
            <div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 14px; border-top: 3px solid {% if mes.estado == 'completado' %}#10b981{% elif mes.estado == 'en_curso' %}#3b82f6{% else %}#9ca3af{% endif %};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="font-size: 0.9rem; color: var(--text-primary);">{{ mes.nombre }}</strong>
                    <span style="font-size: 0.68rem; padding: 2px 6px; border-radius: 4px; background: {% if mes.estado == 'completado' %}#d1fae5{% elif mes.estado == 'en_curso' %}#dbeafe{% else %}#f3f4f6{% endif %}; color: {% if mes.estado == 'completado' %}#059669{% elif mes.estado == 'en_curso' %}#2563eb{% else %}#6b7280{% endif %};">
                        {% if mes.estado == 'completado' %}‚úì Completado{% elif mes.estado == 'en_curso' %}En curso{% else %}Pr√≥ximo{% endif %}
                    </span>
                </div>

                <!-- Barras de progreso por tipo -->
                <div style="font-size: 0.72rem; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                        <span style="color: #3b82f6;">‚óè</span>
                        <span style="flex: 1;">Cal:</span>
                        <div style="width: 60px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                            {% if mes.actividades.calibraciones.programadas > 0 %}
                            <div style="width: {% widthratio mes.actividades.calibraciones.ejecutadas mes.actividades.calibraciones.programadas 100 %}%; height: 100%; background: #3b82f6;"></div>
                            {% endif %}
                        </div>
                        <span style="color: var(--text-secondary);">{{ mes.actividades.calibraciones.ejecutadas }}/{{ mes.actividades.calibraciones.programadas }}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                        <span style="color: #10b981;">‚óè</span>
                        <span style="flex: 1;">Mant:</span>
                        <div style="width: 60px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                            {% if mes.actividades.mantenimientos.programadas > 0 %}
                            <div style="width: {% widthratio mes.actividades.mantenimientos.ejecutadas mes.actividades.mantenimientos.programadas 100 %}%; height: 100%; background: #10b981;"></div>
                            {% endif %}
                        </div>
                        <span style="color: var(--text-secondary);">{{ mes.actividades.mantenimientos.ejecutadas }}/{{ mes.actividades.mantenimientos.programadas }}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="color: #f59e0b;">‚óè</span>
                        <span style="flex: 1;">Comp:</span>
                        <div style="width: 60px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                            {% if mes.actividades.comprobaciones.programadas > 0 %}
                            <div style="width: {% widthratio mes.actividades.comprobaciones.ejecutadas mes.actividades.comprobaciones.programadas 100 %}%; height: 100%; background: #f59e0b;"></div>
                            {% endif %}
                        </div>
                        <span style="color: var(--text-secondary);">{{ mes.actividades.comprobaciones.ejecutadas }}/{{ mes.actividades.comprobaciones.programadas }}</span>
                    </div>
                </div>

                <!-- Presupuesto vs Ejecutado -->
                <div style="border-top: 1px dashed var(--border-color); padding-top: 8px; margin-top: 8px;">
                    {% if mes.estado == 'completado' or mes.estado == 'en_curso' %}
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">
                        üí∞ ${{ mes.presupuesto|floatformat:0 }} ‚Üí ${{ mes.ejecutado|floatformat:0 }}
                    </div>
                    {% if mes.diferencia_porcentaje != 0 %}
                    <div style="font-size: 0.72rem; font-weight: 600; color: {% if mes.diferencia_porcentaje > 10 %}#dc2626{% elif mes.diferencia_porcentaje < -10 %}#059669{% else %}#6b7280{% endif %};">
                        {% if mes.diferencia_porcentaje > 0 %}+{% endif %}{{ mes.diferencia_porcentaje }}% {% if mes.diferencia_porcentaje > 10 %}sobre{% elif mes.diferencia_porcentaje < -10 %}bajo{% else %}~igual{% endif %}
                    </div>
                    {% endif %}
                    {% else %}
                    <div style="font-size: 0.75rem; color: var(--text-muted);">
                        üí∞ ${{ mes.presupuesto|floatformat:0 }} est.
                    </div>
                    <div style="font-size: 0.72rem; color: var(--text-muted);">‚è≥ Pendiente</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- SECCI√ìN ORIGINAL: Tendencias Hist√≥ricas -->
        <h4 style="font-size: 1rem; font-weight: bold; color: var(--text-primary); margin: 0 0 16px 0; padding-top: 16px; border-top: 1px solid var(--border-color);">
            <i class="fas fa-history" style="color: #6b7280; margin-right: 8px;"></i>Historial de Gastos y Actividades
        </h4>
        <div class="pd-metric-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
            <div class="pd-metric-card">
                <h4>Tendencia 3 Meses</h4>
                <div class="pd-metric-value" style="color: {% if tendencias_historicas.tendencia_direccion == 'ASCENDENTE' %}#d97706{% elif tendencias_historicas.tendencia_direccion == 'DESCENDENTE' %}#059669{% else %}#2563eb{% endif %};">
                    {% if tendencias_historicas.tendencia_porcentaje > 0 %}+{% endif %}{{ tendencias_historicas.tendencia_porcentaje }}%
                </div>
                <div class="pd-metric-sub">{{ tendencias_historicas.tendencia_direccion }}</div>
            </div>
            <div class="pd-metric-card">
                <h4>Promedio Mensual</h4>
                <div class="pd-metric-value" style="font-size: 1.3rem;">${{ tendencias_historicas.promedio_mensual|floatformat:0 }}</div>
                <div class="pd-metric-sub">{{ tendencias_historicas.meses_con_datos }} meses</div>
            </div>
            {% if tendencias_historicas.mes_mas_caro %}
            <div class="pd-metric-card">
                <h4>Mes M√°s Caro</h4>
                <div class="pd-metric-value" style="font-size: 1.3rem; color: #dc2626;">{{ tendencias_historicas.mes_mas_caro.nombre_mes }}</div>
                <div class="pd-metric-sub">${{ tendencias_historicas.mes_mas_caro.gasto_total|floatformat:0 }} COP</div>
            </div>
            {% endif %}
            {% if tendencias_historicas.mes_mas_barato %}
            <div class="pd-metric-card">
                <h4>Mes M√°s Barato</h4>
                <div class="pd-metric-value" style="font-size: 1.3rem; color: #059669;">{{ tendencias_historicas.mes_mas_barato.nombre_mes }}</div>
                <div class="pd-metric-sub">${{ tendencias_historicas.mes_mas_barato.gasto_total|floatformat:0 }} COP</div>
            </div>
            {% endif %}
        </div>
        <div class="pd-chart-container">
            <canvas id="tendenciasChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- Tab: Conformidad de Equipos -->
    <div id="detail-conformidad" class="pd-tab-panel">
        <div class="pd-metric-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-bottom: 16px;">
            <div class="pd-gradient-card pd-gradient-{% if compliance_iso9001.evaluacion == 'EXCELENTE' %}green{% elif compliance_iso9001.evaluacion == 'BUENO' %}blue{% else %}blue{% endif %}">
                <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 6px;">Conformidad de Equipos</div>
                <div style="font-size: 2.2rem; font-weight: bold;">{{ compliance_iso9001.score_iso9001 }}%</div>
                <div style="font-size: 0.8rem; opacity: 0.85; margin-top: 4px;">{{ compliance_iso9001.evaluacion }}</div>
            </div>
            <div class="pd-metric-card" style="border-left: 3px solid #10b981;">
                <h4>Conformes</h4>
                <div class="pd-metric-value" style="color: #059669;">{{ compliance_iso9001.equipos_conformes }}</div>
                <div class="pd-metric-sub">de {{ compliance_iso9001.total_equipos }} equipos</div>
            </div>
            {% if compliance_iso9001.equipos_riesgo > 0 %}
            <div class="pd-metric-card" style="border-left: 3px solid #f59e0b;">
                <h4>En Riesgo</h4>
                <div class="pd-metric-value" style="color: #d97706;">{{ compliance_iso9001.equipos_riesgo }}</div>
                <div class="pd-metric-sub">Vencen en &lt;30 d√≠as</div>
            </div>
            {% endif %}
            {% if compliance_iso9001.equipos_no_conformes > 0 %}
            <div class="pd-metric-card" style="border-left: 3px solid #ef4444;">
                <h4>No Conformes</h4>
                <div class="pd-metric-value" style="color: #dc2626;">{{ compliance_iso9001.equipos_no_conformes }}</div>
                <div class="pd-metric-sub">Acci√≥n inmediata</div>
            </div>
            {% endif %}
        </div>

        {% if compliance_iso9001.no_conformidades %}
        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 14px; margin-top: 10px;">
            <strong style="color: #dc2626; font-size: 0.88rem;">Detalle de No Conformidades</strong>
            {% for nc in compliance_iso9001.no_conformidades|slice:":5" %}
            <div style="background: white; border: 1px solid #f87171; border-radius: 6px; padding: 10px; margin-top: 8px;">
                <strong style="color: #dc2626; font-size: 0.85rem;">{{ nc.equipo.codigo_interno }} - {{ nc.equipo.nombre }}</strong>
                <ul style="margin: 4px 0 0 16px; color: #991b1b; font-size: 0.82rem;">
                    {% for problema in nc.problemas %}<li>{{ problema }}</li>{% endfor %}
                </ul>
            </div>
            {% endfor %}
            {% if compliance_iso9001.no_conformidades|length > 5 %}
            <div style="font-size: 0.78rem; color: #991b1b; margin-top: 8px;">... y {{ compliance_iso9001.no_conformidades|length|add:"-5" }} m√°s</div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Tab: Optimizaci√≥n -->
    <div id="detail-optimizacion" class="pd-tab-panel">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Oportunidades -->
            <div>
                <h4 style="font-size: 0.95rem; font-weight: bold; color: #2563eb; margin: 0 0 12px 0;">Oportunidades de Optimizaci√≥n</h4>
                {% if optimizacion_cronogramas.oportunidades_optimizacion %}
                <div class="pd-metric-card" style="margin-bottom: 12px; border-left: 3px solid #10b981;">
                    <div class="pd-metric-value" style="color: #059669;">${{ optimizacion_cronogramas.ahorro_total_cronograma|floatformat:0 }}</div>
                    <div class="pd-metric-sub">Ahorro potencial COP</div>
                </div>
                {% for op in optimizacion_cronogramas.oportunidades_optimizacion %}
                <div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <strong style="font-size: 0.85rem; color: var(--text-primary);">{{ op.ubicacion }}</strong>
                        <span style="font-size: 0.72rem; background: #d1fae5; color: #059669; padding: 2px 6px; border-radius: 4px;">Ahorro: ${{ op.ahorro_estimado|floatformat:0 }}</span>
                    </div>
                    <div style="font-size: 0.78rem; color: var(--text-secondary);">{{ op.cantidad }} actividades ~ {{ op.fecha_sugerida|date:"d/m/Y" }}</div>
                </div>
                {% endfor %}
                {% else %}
                <div class="pd-empty-state"><i class="fas fa-check-circle"></i>Cronograma optimizado</div>
                {% endif %}
            </div>

            <!-- Equipos Problem√°ticos -->
            <div>
                <h4 style="font-size: 0.95rem; font-weight: bold; color: #dc2626; margin: 0 0 12px 0;">Equipos Problem√°ticos</h4>
                {% if optimizacion_cronogramas.equipos_problematicos %}
                {% for ep in optimizacion_cronogramas.equipos_problematicos %}
                <div style="background: {% if ep.nivel_problema == 'CR√çTICO' %}#fef2f2{% elif ep.nivel_problema == 'ALTO' %}#fffbeb{% else %}#eff6ff{% endif %}; border: 1px solid {% if ep.nivel_problema == 'CR√çTICO' %}#fecaca{% elif ep.nivel_problema == 'ALTO' %}#fde68a{% else %}#bfdbfe{% endif %}; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <strong style="font-size: 0.85rem;">{{ ep.equipo.codigo_interno }} - {{ ep.equipo.nombre }}</strong>
                        <span style="font-size: 0.68rem; font-weight: bold; color: white; padding: 2px 6px; border-radius: 4px; background: {% if ep.nivel_problema == 'CR√çTICO' %}#dc2626{% elif ep.nivel_problema == 'ALTO' %}#d97706{% else %}#2563eb{% endif %};">{{ ep.nivel_problema }}</span>
                    </div>
                    <div style="font-size: 0.78rem; color: var(--text-secondary);">{{ ep.cantidad_correctivos }} correctivos en 12 meses{% if ep.costo_total > 0 %} | ${{ ep.costo_total|floatformat:0 }} COP{% endif %}</div>
                    <div style="font-size: 0.75rem; color: var(--text-primary); margin-top: 4px; font-weight: 500;">{{ ep.recomendacion }}</div>
                </div>
                {% endfor %}
                {% else %}
                <div class="pd-empty-state"><i class="fas fa-check-circle"></i>Sin equipos problem√°ticos</div>
                {% endif %}
            </div>
        </div>
    </div>

    {% else %}
    <!-- =================== TABS SAM =================== -->
    <div class="pd-tabs-bar">
        <button class="pd-tab-btn active" onclick="switchTab('detail', 'financiero-sam')">Financiero</button>
        <button class="pd-tab-btn" onclick="switchTab('detail', 'por-empresa')">Por Empresa</button>
        <button class="pd-tab-btn" onclick="switchTab('detail', 'tendencias-sam')">Tendencias</button>
        <button class="pd-tab-btn" onclick="switchTab('detail', 'conformidad-sam')">Conformidad</button>
    </div>

    <!-- Tab SAM: Financiero -->
    <div id="detail-financiero-sam" class="pd-tab-panel active">
        <div class="pd-metric-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
            <div class="pd-metric-card">
                <h4>Ingresos {{ current_year }}</h4>
                <div class="pd-metric-value" style="color: #059669; font-size: 1.3rem;">${{ ingreso_ytd_actual|floatformat:0 }}</div>
                <div class="pd-metric-sub">COP YTD</div>
            </div>
            <div class="pd-metric-card">
                <h4>Crecimiento vs {{ current_year|add:"-1" }}</h4>
                <div class="pd-metric-value" style="color: {% if crecimiento_ingresos_porcentaje >= 0 %}#059669{% else %}#dc2626{% endif %};">{% if crecimiento_ingresos_porcentaje >= 0 %}+{% endif %}{{ crecimiento_ingresos_porcentaje }}%</div>
                <div class="pd-metric-sub">Interanual</div>
            </div>
            <div class="pd-metric-card">
                <h4>Empresas Activas</h4>
                <div class="pd-metric-value">{{ empresas_activas_actual }}</div>
                <div class="pd-metric-sub">Base de clientes</div>
            </div>
            <div class="pd-metric-card">
                <h4>Proyecci√≥n Fin {{ current_year }}</h4>
                <div class="pd-metric-value" style="color: #7c3aed; font-size: 1.3rem;">${{ proyeccion_fin_a√±o|floatformat:0 }}</div>
                <div class="pd-metric-sub">COP estimados</div>
            </div>
        </div>
        <div style="text-align: center;">
            <a href="{% url 'core:exportar_analisis_financiero' %}{% if selected_company_id %}?empresa_id={{ selected_company_id }}{% endif %}" class="pd-btn-detail">
                <i class="fas fa-file-excel"></i> Exportar M√©tricas Financieras
            </a>
        </div>
    </div>

    <!-- Tab SAM: Por Empresa -->
    <div id="detail-por-empresa" class="pd-tab-panel">
        {% if metricas_por_empresa %}
        <div style="overflow-x: auto;">
            <table class="pd-table">
                <thead>
                    <tr>
                        <th>Empresa</th>
                        <th>Salud %</th>
                        <th>Cumplimiento %</th>
                        <th>Eficiencia %</th>
                        <th>Equipos</th>
                    </tr>
                </thead>
                <tbody>
                    {% for m in metricas_por_empresa %}
                    <tr>
                        <td><strong>{{ m.empresa.nombre }}</strong></td>
                        <td>
                            <span style="font-weight: bold; color: {% if m.salud_porcentaje >= 80 %}#059669{% elif m.salud_porcentaje >= 60 %}#2563eb{% elif m.salud_porcentaje >= 40 %}#d97706{% else %}#dc2626{% endif %};">{{ m.salud_porcentaje }}%</span>
                            <span class="estado-badge badge-{% if m.salud_estado == '√ìPTIMO' %}optimo{% elif m.salud_estado == 'BUENO' %}bueno{% elif m.salud_estado == 'EN RIESGO' %}en-riesgo{% else %}critico{% endif %}" style="margin-left: 4px;">{{ m.salud_estado }}</span>
                        </td>
                        <td>
                            <span style="font-weight: bold; color: {% if m.cumplimiento_porcentaje >= 90 %}#059669{% elif m.cumplimiento_porcentaje >= 80 %}#2563eb{% elif m.cumplimiento_porcentaje >= 70 %}#d97706{% else %}#dc2626{% endif %};">{{ m.cumplimiento_porcentaje }}%</span>
                        </td>
                        <td>
                            <span style="font-weight: bold; color: {% if m.eficiencia_porcentaje >= 95 %}#059669{% elif m.eficiencia_porcentaje >= 85 %}#2563eb{% elif m.eficiencia_porcentaje >= 70 %}#d97706{% else %}#dc2626{% endif %};">{{ m.eficiencia_porcentaje }}%</span>
                        </td>
                        <td>{{ m.total_equipos }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="pd-empty-state">No hay empresas para mostrar.</div>
        {% endif %}
    </div>

    <!-- Tab SAM: Tendencias -->
    <div id="detail-tendencias-sam" class="pd-tab-panel">
        <div class="pd-metric-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
            <div class="pd-metric-card">
                <h4>Tendencia 3 Meses</h4>
                <div class="pd-metric-value" style="color: {% if tendencias_historicas.tendencia_direccion == 'ASCENDENTE' %}#d97706{% elif tendencias_historicas.tendencia_direccion == 'DESCENDENTE' %}#059669{% else %}#2563eb{% endif %};">
                    {% if tendencias_historicas.tendencia_porcentaje > 0 %}+{% endif %}{{ tendencias_historicas.tendencia_porcentaje }}%
                </div>
                <div class="pd-metric-sub">{{ tendencias_historicas.tendencia_direccion }}</div>
            </div>
            <div class="pd-metric-card">
                <h4>Promedio Mensual</h4>
                <div class="pd-metric-value" style="font-size: 1.3rem;">${{ tendencias_historicas.promedio_mensual|floatformat:0 }}</div>
                <div class="pd-metric-sub">{{ tendencias_historicas.meses_con_datos }} meses</div>
            </div>
            {% if tendencias_historicas.mes_mas_caro %}
            <div class="pd-metric-card">
                <h4>Mes M√°s Caro</h4>
                <div class="pd-metric-value" style="font-size: 1.3rem; color: #dc2626;">{{ tendencias_historicas.mes_mas_caro.nombre_mes }}</div>
                <div class="pd-metric-sub">${{ tendencias_historicas.mes_mas_caro.gasto_total|floatformat:0 }}</div>
            </div>
            {% endif %}
            {% if tendencias_historicas.mes_mas_barato %}
            <div class="pd-metric-card">
                <h4>Mes M√°s Barato</h4>
                <div class="pd-metric-value" style="font-size: 1.3rem; color: #059669;">{{ tendencias_historicas.mes_mas_barato.nombre_mes }}</div>
                <div class="pd-metric-sub">${{ tendencias_historicas.mes_mas_barato.gasto_total|floatformat:0 }}</div>
            </div>
            {% endif %}
        </div>
        <div class="pd-chart-container">
            <canvas id="tendenciasSamChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- Tab SAM: Conformidad de Equipos -->
    <div id="detail-conformidad-sam" class="pd-tab-panel">
        <div class="pd-metric-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
            <div class="pd-gradient-card pd-gradient-{% if compliance_iso9001.evaluacion == 'EXCELENTE' %}green{% else %}blue{% endif %}">
                <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 6px;">Conformidad de Equipos</div>
                <div style="font-size: 2.2rem; font-weight: bold;">{{ compliance_iso9001.score_iso9001 }}%</div>
                <div style="font-size: 0.8rem; opacity: 0.85; margin-top: 4px;">{{ compliance_iso9001.evaluacion }}</div>
            </div>
            <div class="pd-metric-card" style="border-left: 3px solid #10b981;">
                <h4>Conformes</h4>
                <div class="pd-metric-value" style="color: #059669;">{{ compliance_iso9001.equipos_conformes }}</div>
                <div class="pd-metric-sub">de {{ compliance_iso9001.total_equipos }}</div>
            </div>
            {% if compliance_iso9001.equipos_riesgo > 0 %}
            <div class="pd-metric-card" style="border-left: 3px solid #f59e0b;">
                <h4>En Riesgo</h4>
                <div class="pd-metric-value" style="color: #d97706;">{{ compliance_iso9001.equipos_riesgo }}</div>
            </div>
            {% endif %}
            {% if compliance_iso9001.equipos_no_conformes > 0 %}
            <div class="pd-metric-card" style="border-left: 3px solid #ef4444;">
                <h4>No Conformes</h4>
                <div class="pd-metric-value" style="color: #dc2626;">{{ compliance_iso9001.equipos_no_conformes }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    {% endif %}
</div>

<!-- Footer Compacto -->
<div class="pd-footer">
    Panel de Decisiones {% if perspectiva == 'sam' %}SAM{% else %}{{ empresa.nombre }}{% endif %} |
    Datos: {{ today|date:"d/m/Y" }} |
    Pilares: Salud + Cumplimiento + Eficiencia
</div>

{% endif %} {# fin if not error #}

<!-- ============================================================ -->
<!-- MODAL DETALLE DE EQUIPOS (se mantiene igual)                  -->
<!-- ============================================================ -->
<div id="modalEquiposSalud" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; overflow-y: auto;">
    <div style="background: var(--bg-card); margin: 30px auto; max-width: 1200px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 1.5rem; font-weight: bold;">Detalles de Condici√≥n de Equipos</h2>
            <button onclick="cerrarModalEquiposSalud()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
        </div>
        <div id="modalEquiposSaludResumen" style="padding: 20px 30px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);"></div>
        <div id="modalEquiposSaludContenido" style="padding: 30px; max-height: 600px; overflow-y: auto;"></div>
    </div>
</div>

</div> {# fin pd-container #}

<!-- ============================================================ -->
<!-- JAVASCRIPT                                                     -->
<!-- ============================================================ -->
<script>
/* --- 2 funciones gen√©ricas para tabs --- */
function switchTab(groupId, tabId) {
    // Desactivar todos los paneles del grupo
    document.querySelectorAll('#' + groupId + '-financiero, #' + groupId + '-tendencias, #' + groupId + '-conformidad, #' + groupId + '-optimizacion, #' + groupId + '-financiero-sam, #' + groupId + '-por-empresa, #' + groupId + '-tendencias-sam, #' + groupId + '-conformidad-sam').forEach(function(panel) {
        panel.classList.remove('active');
    });
    // Desactivar todos los botones del grupo
    var tabsBar = document.getElementById(groupId + '-' + tabId);
    if (tabsBar) {
        tabsBar.closest('.pd-detail').querySelectorAll('.pd-tab-btn').forEach(function(btn) {
            btn.classList.remove('active');
        });
    }
    // Activar panel seleccionado
    var panel = document.getElementById(groupId + '-' + tabId);
    if (panel) {
        panel.classList.add('active');
    }
    // Activar bot√≥n que hizo click (via event)
    if (event && event.target) {
        event.target.classList.add('active');
    }
}

function switchActionTab(tabId) {
    // Desactivar todos los paneles de acci√≥n
    document.querySelectorAll('.pd-action-panel').forEach(function(panel) {
        panel.classList.remove('active');
    });
    // Desactivar todos los botones
    document.querySelectorAll('.pd-action-tab').forEach(function(btn) {
        btn.classList.remove('active');
    });
    // Activar panel
    var panel = document.getElementById('action-' + tabId);
    if (panel) {
        panel.classList.add('active');
    }
    // Activar bot√≥n
    if (event && event.target) {
        var btn = event.target.closest('.pd-action-tab');
        if (btn) btn.classList.add('active');
    }
}

/* --- Toggle para listas desplegables --- */
function toggleListItems(listId, button) {
    var items = document.querySelectorAll('.pd-item-row[data-list="' + listId + '"]');
    var isExpanded = button.getAttribute('data-expanded') === 'true';

    items.forEach(function(item, index) {
        if (index >= 5) {
            if (isExpanded) {
                item.classList.add('pd-item-hidden');
            } else {
                item.classList.remove('pd-item-hidden');
            }
        }
    });

    button.setAttribute('data-expanded', !isExpanded);
    var icon = button.querySelector('i');
    if (isExpanded) {
        button.innerHTML = '<i class="fas fa-chevron-down"></i> Ver todos (' + items.length + ')';
    } else {
        button.innerHTML = '<i class="fas fa-chevron-up"></i> Ver menos';
    }
}

/* --- Modal de detalles de equipos --- */
function verDetallesEquiposSalud() {
    var modal = document.getElementById('modalEquiposSalud');
    var contenido = document.getElementById('modalEquiposSaludContenido');
    var resumen = document.getElementById('modalEquiposSaludResumen');

    modal.style.display = 'block';
    contenido.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 2rem;">&#8987;</div><div>Cargando detalles...</div></div>';

    var urlParams = new URLSearchParams(window.location.search);
    var empresaId = urlParams.get('empresa_id') || '{{ selected_company_id|default:"" }}';
    {% if perspectiva == 'empresa' and empresa %}
    if (!empresaId) empresaId = '{{ empresa.id }}';
    {% endif %}

    fetch('/core/api/equipos-salud-detalles/?empresa_id=' + empresaId)
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.error) {
                contenido.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">' + data.error + '</div>';
                return;
            }

            resumen.innerHTML =
                '<div style="display: flex; justify-content: space-around; align-items: center; text-align: center;">' +
                '<div><div style="font-size: 2rem; font-weight: bold; color: #ef4444;">' + data.totales.criticos + '</div><div style="font-size: 0.85rem; color: #6b7280;">CR√çTICOS</div></div>' +
                '<div><div style="font-size: 2rem; font-weight: bold; color: #f59e0b;">' + data.totales.en_riesgo + '</div><div style="font-size: 0.85rem; color: #6b7280;">EN RIESGO</div></div>' +
                '<div><div style="font-size: 2rem; font-weight: bold; color: #10b981;">' + data.totales.saludables + '</div><div style="font-size: 0.85rem; color: #6b7280;">SALUDABLES</div></div>' +
                '<div><div style="font-size: 2rem; font-weight: bold; color: #3b82f6;">' + data.totales.total + '</div><div style="font-size: 0.85rem; color: #6b7280;">TOTAL</div></div>' +
                '</div>';

            var html = '';
            data.equipos.forEach(function(equipo) {
                var colorClasificacion = equipo.clasificacion === 'CR√çTICO' ? '#ef4444' : (equipo.clasificacion === 'EN RIESGO' ? '#f59e0b' : '#10b981');
                var bgClasificacion = equipo.clasificacion === 'CR√çTICO' ? '#fee2e2' : (equipo.clasificacion === 'EN RIESGO' ? '#fef3c7' : '#d1fae5');

                html += '<div style="background: var(--bg-card); border: 1px solid var(--border-color); border-left: 4px solid ' + colorClasificacion + '; border-radius: 8px; padding: 20px; margin-bottom: 15px;">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">' +
                    '<div><h3 style="margin: 0; font-size: 1.1rem; font-weight: bold; color: var(--text-primary);">' + equipo.codigo_interno + ' - ' + equipo.nombre + '</h3>' +
                    '<p style="margin: 5px 0 0; font-size: 0.85rem; color: var(--text-secondary);">' + equipo.marca + ' | ' + equipo.modelo + ' | ' + equipo.estado + '</p></div>' +
                    '<div style="text-align: center;"><div style="font-size: 2rem; font-weight: bold; color: ' + colorClasificacion + ';">' + equipo.puntuacion_total + 'pts</div>' +
                    '<div style="background: ' + bgClasificacion + '; color: ' + colorClasificacion + '; padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: bold;">' + equipo.clasificacion + '</div></div></div>' +
                    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">' +
                    '<div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px;">' +
                    '<div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 5px;">Estado (' + equipo.detalles.estado_equipo.peso + '%)</div>' +
                    '<div style="font-size: 1.2rem; font-weight: bold; color: ' + (equipo.detalles.estado_equipo.puntuacion === 100 ? '#10b981' : '#ef4444') + ';">' + equipo.detalles.estado_equipo.puntuacion + 'pts</div></div>' +
                    '<div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px;">' +
                    '<div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 5px;">Calibraci√≥n (' + equipo.detalles.calibracion.peso + '%)</div>' +
                    '<div style="font-size: 1.2rem; font-weight: bold; color: ' + (equipo.detalles.calibracion.puntuacion === 100 ? '#10b981' : '#ef4444') + ';">' + equipo.detalles.calibracion.puntuacion + 'pts</div>' +
                    '<div style="font-size: 0.7rem; color: var(--text-muted);">' + equipo.detalles.calibracion.estado + ' | ' + equipo.detalles.calibracion.proxima_fecha + '</div></div>' +
                    '<div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px;">' +
                    '<div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 5px;">Mantenimiento (' + equipo.detalles.mantenimiento.peso + '%)</div>' +
                    '<div style="font-size: 1.2rem; font-weight: bold; color: ' + (equipo.detalles.mantenimiento.puntuacion === 100 ? '#10b981' : '#ef4444') + ';">' + equipo.detalles.mantenimiento.puntuacion + 'pts</div>' +
                    '<div style="font-size: 0.7rem; color: var(--text-muted);">' + equipo.detalles.mantenimiento.estado + ' | ' + equipo.detalles.mantenimiento.proxima_fecha + '</div></div>' +
                    '<div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px;">' +
                    '<div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 5px;">Comprobaci√≥n (' + equipo.detalles.comprobacion.peso + '%)</div>' +
                    '<div style="font-size: 1.2rem; font-weight: bold; color: ' + (equipo.detalles.comprobacion.puntuacion === 100 ? '#10b981' : '#ef4444') + ';">' + equipo.detalles.comprobacion.puntuacion + 'pts</div>' +
                    '<div style="font-size: 0.7rem; color: var(--text-muted);">' + equipo.detalles.comprobacion.estado + ' | ' + equipo.detalles.comprobacion.proxima_fecha + '</div></div>' +
                    '</div></div>';
            });

            if (data.equipos.length === 0) {
                html = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">No hay equipos activos para mostrar.</div>';
            }

            contenido.innerHTML = html;
        })
        .catch(function(error) {
            console.error('Error cargando detalles:', error);
            contenido.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error al cargar los detalles. Por favor intente nuevamente.</div>';
        });
}

function cerrarModalEquiposSalud() {
    document.getElementById('modalEquiposSalud').style.display = 'none';
}

document.addEventListener('click', function(event) {
    var modal = document.getElementById('modalEquiposSalud');
    if (event.target === modal) {
        cerrarModalEquiposSalud();
    }
});

/* --- Gr√°fico de Tendencias con Chart.js --- */
{% if tendencias_historicas %}
(function() {
    var tendenciasData = {{ tendencias_chart_data|safe }};
    var canvasId = '{{ perspectiva }}' === 'sam' ? 'tendenciasSamChart' : 'tendenciasChart';
    var canvas = document.getElementById(canvasId);

    if (canvas && tendenciasData && tendenciasData.length > 0) {
        var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        var textColor = isDark ? '#f3f4f6' : '#374151';
        var gridColor = isDark ? '#374151' : '#e5e7eb';

        var labels = tendenciasData.map(function(d) { return d.mes; });
        var gastos = tendenciasData.map(function(d) { return d.gasto; });
        var actividades = tendenciasData.map(function(d) { return d.actividades; });

        new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Gasto ($COP)',
                        data: gastos,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: '#3b82f6',
                        borderWidth: 1,
                        yAxisID: 'y',
                        order: 2
                    },
                    {
                        label: 'Actividades',
                        data: actividades,
                        type: 'line',
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        tension: 0.3,
                        yAxisID: 'y1',
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { labels: { color: textColor, font: { size: 11 } } }
                },
                scales: {
                    x: { ticks: { color: textColor, font: { size: 10 } }, grid: { color: gridColor } },
                    y: {
                        position: 'left',
                        ticks: { color: textColor, font: { size: 10 }, callback: function(v) { return '$' + v.toLocaleString(); } },
                        grid: { color: gridColor }
                    },
                    y1: {
                        position: 'right',
                        ticks: { color: '#10b981', font: { size: 10 } },
                        grid: { display: false }
                    }
                }
            }
        });
    }
})();
{% endif %}

/* --- Gr√°fico de Presupuesto vs Ejecuci√≥n --- */
{% if presupuesto_vs_ejecutado_chart_data and perspectiva == 'empresa' %}
(function() {
    var presupuestoData = {{ presupuesto_vs_ejecutado_chart_data|safe }};
    var canvas = document.getElementById('presupuestoVsEjecucionChart');

    if (canvas && presupuestoData && presupuestoData.length > 0) {
        var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        var textColor = isDark ? '#f3f4f6' : '#374151';
        var gridColor = isDark ? '#374151' : '#e5e7eb';

        var labels = presupuestoData.map(function(d) { return d.mes; });
        var presupuestos = presupuestoData.map(function(d) { return d.presupuesto; });
        var ejecutados = presupuestoData.map(function(d) { return d.ejecutado; });

        // Mes actual para dividir datos pasados vs futuros
        var mesActual = {{ today.month }};

        new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Ejecutado',
                        data: ejecutados.map(function(val, idx) {
                            return idx < mesActual ? val : null;
                        }),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.15)',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#3b82f6',
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'Presupuesto',
                        data: presupuestos,
                        borderColor: '#9ca3af',
                        borderDash: [5, 5],
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: '#9ca3af',
                        fill: false,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        labels: { color: textColor, font: { size: 11 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var label = context.dataset.label || '';
                                if (context.parsed.y !== null) {
                                    label += ': $' + context.parsed.y.toLocaleString() + ' COP';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: textColor, font: { size: 10 } },
                        grid: { color: gridColor }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: textColor,
                            font: { size: 10 },
                            callback: function(v) { return '$' + (v / 1000).toFixed(0) + 'K'; }
                        },
                        grid: { color: gridColor }
                    }
                }
            }
        });
    }
})();
{% endif %}
</script>
{% endblock %}
