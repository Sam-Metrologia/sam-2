{% extends 'base.html' %}
{% load static %}

{% block title %}Aprobaciones{% endblock %}

{% block extra_head %}
<style>
    /* ===== MODO OSCURO: Aprobaciones ===== */

    /* Encabezados de secci√≥n con colores de fondo */
    [data-theme="dark"] .bg-purple-50 {
        background-color: rgba(147, 51, 234, 0.15) !important;
    }
    [data-theme="dark"] .bg-blue-50 {
        background-color: rgba(59, 130, 246, 0.15) !important;
    }
    [data-theme="dark"] .bg-green-50 {
        background-color: rgba(34, 197, 94, 0.15) !important;
    }
    [data-theme="dark"] .bg-yellow-50 {
        background-color: rgba(251, 191, 36, 0.15) !important;
    }
    [data-theme="dark"] .bg-gray-50 {
        background-color: var(--bg-tertiary) !important;
    }

    /* Textos en encabezados de secci√≥n */
    [data-theme="dark"] .text-gray-800 {
        color: var(--text-primary) !important;
    }
    [data-theme="dark"] .text-gray-600 {
        color: var(--text-secondary) !important;
    }
    [data-theme="dark"] .text-gray-500 {
        color: var(--text-muted) !important;
    }
    [data-theme="dark"] .text-purple-800,
    [data-theme="dark"] .text-yellow-800,
    [data-theme="dark"] .text-yellow-900,
    [data-theme="dark"] .text-green-800,
    [data-theme="dark"] .text-green-900 {
        color: var(--text-primary) !important;
    }

    /* Tablas con fondo blanco */
    [data-theme="dark"] .bg-white {
        background-color: var(--bg-card) !important;
    }
    [data-theme="dark"] .bg-white tbody {
        background-color: var(--bg-card) !important;
    }
    [data-theme="dark"] table tbody tr {
        background-color: var(--bg-card) !important;
    }
    [data-theme="dark"] table tbody tr:hover {
        background-color: var(--bg-tertiary) !important;
    }
    [data-theme="dark"] .hover\:bg-purple-50:hover,
    [data-theme="dark"] .hover\:bg-blue-50:hover,
    [data-theme="dark"] .hover\:bg-green-50:hover {
        background-color: var(--bg-tertiary) !important;
    }

    /* Textos dentro de tablas */
    [data-theme="dark"] .text-gray-900 {
        color: var(--text-primary) !important;
    }
    [data-theme="dark"] .text-gray-700 {
        color: var(--text-secondary) !important;
    }

    /* Divisores */
    [data-theme="dark"] .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
        border-color: var(--border-color) !important;
    }

    /* Sombras */
    [data-theme="dark"] .shadow {
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Encabezado -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fas fa-check-circle text-blue-600 mr-3"></i>
            {% if es_aprobador %}
                Aprobaciones Pendientes
            {% else %}
                Mis Documentos
            {% endif %}
        </h1>
        <p class="text-gray-600">
            {% if es_aprobador %}
                Revisa y aprueba los documentos generados por tu equipo.
            {% else %}
                Estado de tus documentos enviados para aprobaci√≥n.
            {% endif %}
        </p>
    </div>

    <!-- Resumen de pendientes -->
    {% if total_pendientes > 0 %}
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-lg">
        <div class="flex items-center">
            <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mr-3"></i>
            <div>
                <h3 class="text-lg font-semibold text-yellow-900">
                    {{ total_pendientes }} documento{{ total_pendientes|pluralize }} pendiente{{ total_pendientes|pluralize }}
                </h3>
                {% if es_aprobador %}
                <p class="text-sm text-yellow-800">
                    Requieren tu aprobaci√≥n para ser descargables.
                </p>
                {% else %}
                <p class="text-sm text-yellow-800">
                    Esperando aprobaci√≥n de gerencia.
                </p>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-6 rounded-lg">
        <div class="flex items-center">
            <i class="fas fa-check-circle text-green-600 text-2xl mr-3"></i>
            <div>
                <h3 class="text-lg font-semibold text-green-900">
                    No hay documentos pendientes
                </h3>
                <p class="text-sm text-green-800">
                    Todos los documentos est√°n aprobados o no hay nuevos documentos.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- CONFIRMACIONES METROL√ìGICAS -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center bg-blue-50 p-3 rounded-lg border-l-4 border-blue-600">
            <i class="fas fa-check-circle text-blue-600 mr-2"></i>
            Confirmaciones Metrol√≥gicas
            {% if confirmaciones_pendientes %}
            <span class="ml-3 bg-yellow-100 text-yellow-800 text-sm font-medium px-3 py-1 rounded-full">
                {{ confirmaciones_pendientes.count }}
            </span>
            {% endif %}
        </h2>

        {% if confirmaciones_pendientes %}
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-blue-600">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Equipo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Fecha</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Creado por</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Estado</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-white uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for calibracion in confirmaciones_pendientes %}
                    <tr id="confirmacion-{{ calibracion.id }}" class="hover:bg-blue-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">
                                {{ calibracion.equipo.codigo_interno }}
                            </div>
                            <div class="text-sm text-gray-600">
                                {{ calibracion.equipo.nombre }}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            {{ calibracion.fecha_calibracion|date:"Y-m-d" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            {% if calibracion.creado_por %}
                                {{ calibracion.creado_por.get_full_name|default:calibracion.creado_por.username }}
                            {% else %}
                                <span class="text-gray-400">Sin info</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div>
                                <span class="estado-badge px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full
                                    {% if calibracion.confirmacion_estado_aprobacion == 'pendiente' %}bg-yellow-100 text-yellow-800
                                    {% elif calibracion.confirmacion_estado_aprobacion == 'aprobado' %}bg-green-100 text-green-800
                                    {% elif calibracion.confirmacion_estado_aprobacion == 'rechazado' %}bg-red-100 text-red-800
                                    {% endif %}">
                                    {% if calibracion.confirmacion_estado_aprobacion == 'pendiente' %}
                                        üü° Pendiente
                                    {% elif calibracion.confirmacion_estado_aprobacion == 'aprobado' %}
                                        ‚úÖ Aprobado
                                    {% elif calibracion.confirmacion_estado_aprobacion == 'rechazado' %}
                                        ‚ùå Rechazado
                                    {% endif %}
                                </span>
                            </div>
                            {% if calibracion.confirmacion_estado_aprobacion == 'rechazado' and calibracion.confirmacion_observaciones_rechazo %}
                                <div class="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded border-l-2 border-red-400">
                                    <strong>Motivo del rechazo:</strong><br>
                                    {{ calibracion.confirmacion_observaciones_rechazo }}
                                    {% if not es_aprobador %}
                                    <a href="{% url 'core:confirmacion_metrologica' calibracion.equipo.id %}?calibracion_id={{ calibracion.id }}"
                                       class="mt-2 inline-block bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">
                                        <i class="fas fa-edit"></i> Corregir
                                    </a>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <a href="{% url 'core:generar_pdf_confirmacion' calibracion.equipo.id %}?calibracion_id={{ calibracion.id }}"
                               target="_blank"
                               class="text-blue-600 hover:text-blue-900 mr-3"
                               title="Ver PDF">
                                <i class="fas fa-eye"></i>
                            </a>

                            {% if es_aprobador and calibracion.creado_por != user and calibracion.confirmacion_estado_aprobacion == 'pendiente' %}
                            <button onclick="aprobarConfirmacion({{ calibracion.id }}, '{{ calibracion.fecha_calibracion|date:'Y-m-d' }}')"
                                    class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs mr-2">
                                <i class="fas fa-check"></i> Aprobar
                            </button>
                            <button onclick="mostrarModalRechazo({{ calibracion.id }}, 'confirmacion')"
                                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                                <i class="fas fa-times"></i> Rechazar
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="bg-gray-50 rounded-lg p-6 text-center text-gray-500">
            <i class="fas fa-inbox text-4xl mb-2"></i>
            <p>No hay confirmaciones metrol√≥gicas pendientes</p>
        </div>
        {% endif %}
    </div>

    <!-- INTERVALOS DE CALIBRACI√ìN -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center bg-purple-50 p-3 rounded-lg border-l-4 border-purple-600">
            <i class="fas fa-calendar-alt text-purple-600 mr-2"></i>
            Intervalos de Calibraci√≥n
            {% if intervalos_pendientes %}
            <span class="ml-3 bg-yellow-100 text-yellow-800 text-sm font-medium px-3 py-1 rounded-full">
                {{ intervalos_pendientes.count }}
            </span>
            {% endif %}
        </h2>

        {% if intervalos_pendientes %}
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-purple-600">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Equipo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Fecha</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Creado por</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Estado</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-white uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for calibracion in intervalos_pendientes %}
                    <tr id="intervalo-{{ calibracion.id }}" class="hover:bg-purple-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">
                                {{ calibracion.equipo.codigo_interno }}
                            </div>
                            <div class="text-sm text-gray-600">
                                {{ calibracion.equipo.nombre }}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            {{ calibracion.fecha_calibracion|date:"Y-m-d" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            {% if calibracion.creado_por %}
                                {{ calibracion.creado_por.get_full_name|default:calibracion.creado_por.username }}
                            {% else %}
                                <span class="text-gray-400">Sin info</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div>
                                <span class="estado-badge px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full
                                    {% if calibracion.intervalos_estado_aprobacion == 'pendiente' %}bg-yellow-100 text-yellow-800
                                    {% elif calibracion.intervalos_estado_aprobacion == 'aprobado' %}bg-green-100 text-green-800
                                    {% elif calibracion.intervalos_estado_aprobacion == 'rechazado' %}bg-red-100 text-red-800
                                    {% endif %}">
                                    {% if calibracion.intervalos_estado_aprobacion == 'pendiente' %}
                                        üü° Pendiente
                                    {% elif calibracion.intervalos_estado_aprobacion == 'aprobado' %}
                                        ‚úÖ Aprobado
                                    {% elif calibracion.intervalos_estado_aprobacion == 'rechazado' %}
                                        ‚ùå Rechazado
                                    {% endif %}
                                </span>
                            </div>
                            {% if calibracion.intervalos_estado_aprobacion == 'rechazado' and calibracion.intervalos_observaciones_rechazo %}
                                <div class="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded border-l-2 border-red-400">
                                    <strong>Motivo del rechazo:</strong><br>
                                    {{ calibracion.intervalos_observaciones_rechazo }}
                                    {% if not es_aprobador %}
                                    <a href="{% url 'core:intervalos_calibracion' calibracion.equipo.id %}?calibracion_id={{ calibracion.id }}"
                                       class="mt-2 inline-block bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">
                                        <i class="fas fa-edit"></i> Corregir
                                    </a>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <a href="{% url 'core:generar_pdf_intervalos' calibracion.equipo.id %}?calibracion_id={{ calibracion.id }}"
                               target="_blank"
                               class="text-blue-600 hover:text-blue-900 mr-3"
                               title="Ver PDF">
                                <i class="fas fa-eye"></i>
                            </a>

                            {% if es_aprobador and calibracion.creado_por != user and calibracion.intervalos_estado_aprobacion == 'pendiente' %}
                            <button onclick="aprobarIntervalos({{ calibracion.id }}, '{{ calibracion.fecha_calibracion|date:'Y-m-d' }}')"
                                    class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs mr-2">
                                <i class="fas fa-check"></i> Aprobar
                            </button>
                            <button onclick="mostrarModalRechazo({{ calibracion.id }}, 'intervalo')"
                                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                                <i class="fas fa-times"></i> Rechazar
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="bg-gray-50 rounded-lg p-6 text-center text-gray-500">
            <i class="fas fa-inbox text-4xl mb-2"></i>
            <p>No hay intervalos de calibraci√≥n pendientes</p>
        </div>
        {% endif %}
    </div>

    <!-- COMPROBACIONES METROL√ìGICAS -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center bg-green-50 p-3 rounded-lg border-l-4 border-green-600">
            <i class="fas fa-clipboard-check text-green-600 mr-2"></i>
            Comprobaciones Metrol√≥gicas
            {% if comprobaciones_pendientes %}
            <span class="ml-3 bg-yellow-100 text-yellow-800 text-sm font-medium px-3 py-1 rounded-full">
                {{ comprobaciones_pendientes.count }}
            </span>
            {% endif %}
        </h2>

        {% if comprobaciones_pendientes %}
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-green-600">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Equipo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Fecha</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Creado por</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Estado</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-white uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for comprobacion in comprobaciones_pendientes %}
                    <tr id="comprobacion-{{ comprobacion.id }}" class="hover:bg-green-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">
                                {{ comprobacion.equipo.codigo_interno }}
                            </div>
                            <div class="text-sm text-gray-600">
                                {{ comprobacion.equipo.nombre }}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            {{ comprobacion.fecha_comprobacion|date:"Y-m-d" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            {% if comprobacion.creado_por %}
                                {{ comprobacion.creado_por.get_full_name|default:comprobacion.creado_por.username }}
                            {% else %}
                                <span class="text-gray-400">Sin info</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div>
                                <span class="estado-badge px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full
                                    {% if comprobacion.estado_aprobacion == 'pendiente' %}bg-yellow-100 text-yellow-800
                                    {% elif comprobacion.estado_aprobacion == 'aprobado' %}bg-green-100 text-green-800
                                    {% elif comprobacion.estado_aprobacion == 'rechazado' %}bg-red-100 text-red-800
                                    {% endif %}">
                                    {% if comprobacion.estado_aprobacion == 'pendiente' %}
                                        üü° Pendiente
                                    {% elif comprobacion.estado_aprobacion == 'aprobado' %}
                                        ‚úÖ Aprobado
                                    {% elif comprobacion.estado_aprobacion == 'rechazado' %}
                                        ‚ùå Rechazado
                                    {% endif %}
                                </span>
                            </div>
                            {% if comprobacion.estado_aprobacion == 'rechazado' and comprobacion.observaciones_rechazo %}
                                <div class="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded border-l-2 border-red-400">
                                    <strong>Motivo del rechazo:</strong><br>
                                    {{ comprobacion.observaciones_rechazo }}
                                    {% if not es_aprobador %}
                                    <a href="{% url 'core:comprobacion_metrologica' comprobacion.equipo.id %}?comprobacion_id={{ comprobacion.id }}"
                                       class="mt-2 inline-block bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">
                                        <i class="fas fa-edit"></i> Corregir
                                    </a>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <a href="{% url 'core:generar_pdf_comprobacion' comprobacion.equipo.id %}?comprobacion_id={{ comprobacion.id }}"
                               target="_blank"
                               class="text-blue-600 hover:text-blue-900 mr-3"
                               title="Ver PDF">
                                <i class="fas fa-eye"></i>
                            </a>

                            {% if es_aprobador and comprobacion.creado_por != user and comprobacion.estado_aprobacion == 'pendiente' %}
                            <button onclick="aprobarComprobacion({{ comprobacion.id }}, '{{ comprobacion.fecha_comprobacion|date:'Y-m-d' }}')"
                                    class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs mr-2">
                                <i class="fas fa-check"></i> Aprobar
                            </button>
                            <button onclick="mostrarModalRechazo({{ comprobacion.id }}, 'comprobacion')"
                                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                                <i class="fas fa-times"></i> Rechazar
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="bg-gray-50 rounded-lg p-6 text-center text-gray-500">
            <i class="fas fa-inbox text-4xl mb-2"></i>
            <p>No hay comprobaciones metrol√≥gicas pendientes</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de Rechazo -->
<div id="modalRechazo" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            Rechazar Documento
        </h3>
        <p class="text-sm text-gray-600 mb-4">
            Por favor, indica la raz√≥n del rechazo para que el t√©cnico pueda corregir.
        </p>
        <textarea id="observacionesRechazo"
                  rows="4"
                  class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-red-500"
                  placeholder="Ej: Los datos del punto 3 son incorrectos. Verificar tolerancias."></textarea>
        <div class="mt-4 flex justify-end space-x-2">
            <button onclick="cerrarModalRechazo()"
                    class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded">
                Cancelar
            </button>
            <button onclick="confirmarRechazo()"
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded">
                Confirmar Rechazo
            </button>
        </div>
    </div>
</div>

<!-- Modal de Aprobaci√≥n con Fechas Ajustables -->
<div id="modalAprobacion" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 shadow-xl">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">
            Aprobar Documento
        </h3>
        <p class="text-sm text-gray-600 mb-4">
            Puedes ajustar las fechas para cumplir con requisitos de auditor√≠a. Por defecto se usar√°n las fechas del sistema.
        </p>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Fecha de Realizaci√≥n
                </label>
                <input type="date" id="fechaRealizacion"
                       class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Fecha de Emisi√≥n
                </label>
                <input type="date" id="fechaEmision"
                       class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Fecha de Aprobaci√≥n
                </label>
                <input type="date" id="fechaAprobacionAjustable"
                       class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
        </div>

        <div class="mt-6 flex justify-end space-x-2">
            <button onclick="cerrarModalAprobacion()"
                    class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded">
                Cancelar
            </button>
            <button onclick="confirmarAprobacion()"
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded">
                Aprobar
            </button>
        </div>
    </div>
</div>

<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
let documentoParaRechazar = null;
let tipoDocumentoRechazar = null;
let documentoParaAprobar = null;
let tipoDocumentoAprobar = null;
let fechaActividadOriginal = null;

// Funci√≥n para mostrar notificaciones toast
function showToast(message, type = 'info') {
    // Crear elemento toast
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in-down ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
        type === 'warning' ? 'bg-yellow-500' :
        'bg-blue-500'
    } text-white font-medium`;
    toast.textContent = message;
    document.body.appendChild(toast);

    // Remover despu√©s de 4 segundos
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.5s';
        setTimeout(() => toast.remove(), 500);
    }, 4000);
}

// Aprobar Confirmaci√≥n
function aprobarConfirmacion(calibracionId, fechaActividad) {
    documentoParaAprobar = calibracionId;
    tipoDocumentoAprobar = 'confirmacion';
    fechaActividadOriginal = fechaActividad;
    mostrarModalAprobacion();
}

// Aprobar Intervalos
function aprobarIntervalos(calibracionId, fechaActividad) {
    documentoParaAprobar = calibracionId;
    tipoDocumentoAprobar = 'intervalo';
    fechaActividadOriginal = fechaActividad;
    mostrarModalAprobacion();
}

// Aprobar Comprobaci√≥n
function aprobarComprobacion(comprobacionId, fechaActividad) {
    documentoParaAprobar = comprobacionId;
    tipoDocumentoAprobar = 'comprobacion';
    fechaActividadOriginal = fechaActividad;
    mostrarModalAprobacion();
}

// Modal de Rechazo
function mostrarModalRechazo(documentoId, tipo) {
    documentoParaRechazar = documentoId;
    tipoDocumentoRechazar = tipo;
    document.getElementById('modalRechazo').classList.remove('hidden');
    document.getElementById('modalRechazo').classList.add('flex');
    document.getElementById('observacionesRechazo').value = '';
}

function cerrarModalRechazo() {
    document.getElementById('modalRechazo').classList.add('hidden');
    document.getElementById('modalRechazo').classList.remove('flex');
    documentoParaRechazar = null;
    tipoDocumentoRechazar = null;
}

function confirmarRechazo() {
    const observaciones = document.getElementById('observacionesRechazo').value.trim();

    if (!observaciones) {
        showToast('Debes proporcionar observaciones', 'error');
        return;
    }

    let url;
    if (tipoDocumentoRechazar === 'confirmacion') {
        url = `/core/calibracion/${documentoParaRechazar}/rechazar-confirmacion/`;
    } else if (tipoDocumentoRechazar === 'intervalo') {
        url = `/core/calibracion/${documentoParaRechazar}/rechazar-intervalos/`;
    } else if (tipoDocumentoRechazar === 'comprobacion') {
        url = `/core/comprobacion/${documentoParaRechazar}/rechazar/`;
    } else {
        showToast('Tipo de documento no soportado para rechazo', 'error');
        return;
    }

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ observaciones: observaciones })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('‚úì ' + data.message, 'success');
            cerrarModalRechazo();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('‚úó ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error al rechazar', 'error');
        console.error(error);
    });
}

// Modal de Aprobaci√≥n
function mostrarModalAprobacion() {
    const hoy = new Date().toISOString().split('T')[0];

    // Establecer valores por defecto
    document.getElementById('fechaRealizacion').value = fechaActividadOriginal || hoy;
    document.getElementById('fechaEmision').value = hoy;
    document.getElementById('fechaAprobacionAjustable').value = hoy;

    // Mostrar modal
    document.getElementById('modalAprobacion').classList.remove('hidden');
    document.getElementById('modalAprobacion').classList.add('flex');
}

function cerrarModalAprobacion() {
    document.getElementById('modalAprobacion').classList.add('hidden');
    document.getElementById('modalAprobacion').classList.remove('flex');
    documentoParaAprobar = null;
    tipoDocumentoAprobar = null;
    fechaActividadOriginal = null;
}

function confirmarAprobacion() {
    const fechaRealizacion = document.getElementById('fechaRealizacion').value;
    const fechaEmision = document.getElementById('fechaEmision').value;
    const fechaAprobacionAjustable = document.getElementById('fechaAprobacionAjustable').value;

    if (!fechaRealizacion || !fechaEmision || !fechaAprobacionAjustable) {
        showToast('Todas las fechas son requeridas', 'error');
        return;
    }

    let url, elementId;
    if (tipoDocumentoAprobar === 'confirmacion') {
        url = `/core/calibracion/${documentoParaAprobar}/aprobar-confirmacion/`;
        elementId = `confirmacion-${documentoParaAprobar}`;
    } else if (tipoDocumentoAprobar === 'intervalo') {
        url = `/core/calibracion/${documentoParaAprobar}/aprobar-intervalos/`;
        elementId = `intervalo-${documentoParaAprobar}`;
    } else if (tipoDocumentoAprobar === 'comprobacion') {
        url = `/core/comprobacion/${documentoParaAprobar}/aprobar/`;
        elementId = `comprobacion-${documentoParaAprobar}`;
    } else {
        showToast('Tipo de documento no soportado', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('fecha_realizacion', fechaRealizacion);
    formData.append('fecha_emision', fechaEmision);
    formData.append('fecha_aprobacion_ajustable', fechaAprobacionAjustable);

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('‚úì ' + data.message, 'success');
            cerrarModalAprobacion();
            document.getElementById(elementId)?.remove();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('‚úó ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error al aprobar', 'error');
        console.error(error);
    });
}
</script>
{% endblock %}
