# GitHub Action: Auditoria Semanal de Dependencias
# Se ejecuta los miercoles a las 9:00 AM (hora Colombia = UTC-5 = 14:00 UTC)
# Escanea CVEs con pip-audit y crea un issue si encuentra vulnerabilidades

name: Auditoria Semanal de Dependencias

on:
  schedule:
    # Miercoles 14:00 UTC = Miercoles 9:00 AM Colombia
    - cron: '0 14 * * 3'
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

jobs:
  audit-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pip-audit

      - name: Ejecutar pip-audit
        id: audit
        continue-on-error: true
        run: |
          echo "## Resultado de pip-audit" > audit_report.md
          echo "" >> audit_report.md
          echo "Fecha: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> audit_report.md
          echo "" >> audit_report.md

          if pip-audit --format=markdown 2>/dev/null >> audit_report.md; then
            echo "audit_result=clean" >> $GITHUB_OUTPUT
            echo "Sin vulnerabilidades encontradas." >> audit_report.md
          else
            echo "audit_result=vulnerable" >> $GITHUB_OUTPUT
          fi

          echo "" >> audit_report.md
          echo "---" >> audit_report.md
          echo "" >> audit_report.md
          echo "### Resumen de versiones criticas" >> audit_report.md
          echo "| Paquete | Version Instalada |" >> audit_report.md
          echo "|---------|-------------------|" >> audit_report.md
          pip show Django cryptography Pillow urllib3 Werkzeug 2>/dev/null | grep -E "^(Name|Version)" | paste - - | awk -F': ' '{print "| " $2 " | " $4 " |"}' >> audit_report.md

          cat audit_report.md

      - name: Crear issue si hay vulnerabilidades
        if: steps.audit.outputs.audit_result == 'vulnerable'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('audit_report.md', 'utf8');

            const today = new Date().toISOString().split('T')[0];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[SEGURIDAD] CVEs detectados en dependencias - ${today}`,
              body: `# Auditoria Automatica de Dependencias\n\n${report}\n\n## Accion Requerida\n\n1. Revisar las vulnerabilidades listadas\n2. Actualizar las dependencias afectadas: \`pip install --upgrade <paquete>\`\n3. Correr tests: \`python -m pytest\`\n4. Actualizar \`requirements.txt\` con las nuevas versiones\n5. Actualizar \`docs/DEPENDENCY_MANAGEMENT.md\` con la fecha de actualizacion\n\nVer [Guia de Mantenimiento de Dependencias](../docs/DEPENDENCY_MANAGEMENT.md) para el procedimiento completo.\n\n---\n*Issue creado automaticamente por GitHub Actions*`,
              labels: ['security', 'dependencies']
            });

      - name: Resumen
        run: |
          if [ "${{ steps.audit.outputs.audit_result }}" == "clean" ]; then
            echo "Sin vulnerabilidades. Dependencias al dia."
          else
            echo "VULNERABILIDADES DETECTADAS. Se creo un issue en GitHub."
          fi
