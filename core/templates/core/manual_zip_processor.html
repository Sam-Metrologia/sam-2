{% extends 'base.html' %}

{% block title %}Procesador Manual de ZIP{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">
        <i class="fas fa-cogs mr-3"></i>Procesador Manual de ZIP
    </h1>

    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-6">
        <p><strong>Solo para Superusuarios:</strong> Use este panel cuando el procesamiento automático no funcione.</p>
    </div>

    <!-- Estado de la Cola -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">
                <i class="fas fa-clock text-blue-500 mr-2"></i>Solicitudes Pendientes
            </h3>
            {% if pending_requests %}
                <div class="space-y-2">
                    {% for req in pending_requests %}
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded">
                        <span>ID #{{ req.id }} - {{ req.user.username }}</span>
                        <span class="text-sm text-gray-500">Posición: {{ req.position_in_queue }}</span>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500">No hay solicitudes pendientes</p>
            {% endif %}
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">
                <i class="fas fa-spinner text-green-500 mr-2"></i>En Procesamiento
            </h3>
            {% if processing_requests %}
                <div class="space-y-2">
                    {% for req in processing_requests %}
                    <div class="flex justify-between items-center bg-green-50 p-3 rounded">
                        <span>ID #{{ req.id }} - {{ req.user.username }}</span>
                        <span class="text-sm text-gray-500">Iniciado: {{ req.started_at|date:"H:i" }}</span>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500">Ninguna solicitud procesándose</p>
            {% endif %}
        </div>
    </div>

    <!-- Botón de Procesamiento Manual -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">
            <i class="fas fa-play text-purple-500 mr-2"></i>Procesamiento Manual
        </h3>

        <button id="processBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg">
            <i class="fas fa-play mr-2"></i>Procesar Próxima Solicitud
        </button>

        <div id="processOutput" class="mt-4 hidden">
            <h4 class="font-semibold text-gray-700 mb-2">Resultado:</h4>
            <pre id="outputContent" class="bg-gray-100 p-4 rounded text-sm overflow-x-auto"></pre>
        </div>
    </div>
</div>

<script>
document.getElementById('processBtn').addEventListener('click', function() {
    const btn = this;
    const output = document.getElementById('processOutput');
    const content = document.getElementById('outputContent');

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Procesando...';

    fetch('/core/manual_process_zip/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        output.classList.remove('hidden');
        content.textContent = data.output || data.message;

        if (data.status === 'success') {
            btn.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg';
            btn.innerHTML = '<i class="fas fa-check mr-2"></i>Procesado Exitosamente';
        } else {
            btn.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg';
            btn.innerHTML = '<i class="fas fa-times mr-2"></i>Error en Procesamiento';
        }

        // Recargar página después de 3 segundos
        setTimeout(() => window.location.reload(), 3000);
    })
    .catch(error => {
        output.classList.remove('hidden');
        content.textContent = 'Error: ' + error.message;
        btn.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg';
        btn.innerHTML = '<i class="fas fa-times mr-2"></i>Error en Procesamiento';
    })
    .finally(() => {
        btn.disabled = false;
    });
});
</script>
{% endblock %}