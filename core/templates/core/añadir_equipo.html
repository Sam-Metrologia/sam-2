{% extends 'base.html' %}
{% load static %}
{% load file_tags %}

{% block title %}Añadir Nuevo Equipo{% endblock %}

{% block header_title %}Añadir Nuevo Equipo{% endblock %}

{% block content %}
<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Formulario de Nuevo Equipo</h2>

        {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                    <div class="p-3 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% if limite_alcanzado %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
            <strong class="font-bold">Atención:</strong>
            <span class="block sm:inline">Esta empresa ha alcanzado su límite de equipos. No puedes añadir más equipos.</span>
        </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            {# Campo empresa (oculto para usuarios normales, visible para superusuarios) #}
            {% for field in form %}
                {% if field.name == 'empresa' %}
                    {% if field.field.widget.input_type == 'hidden' %}
                        {{ field }}
                    {% else %}
                        <div class="bg-gray-50 border-l-4 border-indigo-500 p-4 rounded mb-5">
                            <label for="{{ field.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-1">{{ field.label }}:</label>
                            <div class="relative">
                                <select name="{{ field.name }}" id="{{ field.id_for_label }}"
                                        class="block appearance-none w-full bg-white border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-blue-500"
                                        {% if field.field.widget.attrs.disabled %}disabled{% endif %}
                                        {% if field.field.required %}required{% endif %}>
                                    {% if not field.field.required %}<option value="">---------</option>{% endif %}
                                    {% for value, label in field.field.choices %}
                                        <option value="{{ value }}" {% if value == field.value|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                </div>
                            </div>
                            {% for error in field.errors %}<p class="text-red-500 text-xs mt-1">{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}
                {% endif %}
            {% endfor %}

            {# === SECCIÓN: Identificación del Equipo === #}
            <div class="border border-gray-200 rounded-lg p-4 mb-5">
                <h3 class="text-sm font-semibold text-indigo-700 uppercase tracking-wide mb-3">Identificación del Equipo</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-3">
                    {% for field in form %}
                        {% if field.name == 'codigo_interno' or field.name == 'nombre' or field.name == 'tipo_equipo' or field.name == 'marca' or field.name == 'modelo' or field.name == 'numero_serie' or field.name == 'estado' %}
                            <div>
                                <label for="{{ field.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-1">{{ field.label }}:</label>
                                {% if field.name == 'tipo_equipo' %}
                                    <div class="relative">
                                        <select name="{{ field.name }}" id="{{ field.id_for_label }}"
                                                class="block appearance-none w-full bg-white border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-blue-500"
                                                {% if field.field.required %}required{% endif %}>
                                            {% if not field.field.required %}<option value="">---------</option>{% endif %}
                                            {% for value, label in field.field.choices %}
                                                <option value="{{ value }}" {% if value == field.value|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                        </div>
                                    </div>
                                {% else %}
                                    {{ field }}
                                {% endif %}
                                {% if field.help_text %}<p class="text-gray-500 text-xs mt-1">{{ field.help_text }}</p>{% endif %}
                                {% for error in field.errors %}<p class="text-red-500 text-xs">{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            {# === SECCIÓN: Ubicación y Responsable === #}
            <div class="border border-gray-200 rounded-lg p-4 mb-5">
                <h3 class="text-sm font-semibold text-indigo-700 uppercase tracking-wide mb-3">Ubicación y Responsable</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-3">
                    {% for field in form %}
                        {% if field.name == 'ubicacion' or field.name == 'responsable' or field.name == 'proveedor' %}
                            <div>
                                <label for="{{ field.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-1">{{ field.label }}:</label>
                                {{ field }}
                                {% if field.help_text %}<p class="text-gray-500 text-xs mt-1">{{ field.help_text }}</p>{% endif %}
                                {% for error in field.errors %}<p class="text-red-500 text-xs">{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            {# === SECCIÓN: Características Metrológicas === #}
            <div class="border border-gray-200 rounded-lg p-4 mb-5">
                <h3 class="text-sm font-semibold text-indigo-700 uppercase tracking-wide mb-3">Características Metrológicas</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-3">
                    {% for field in form %}
                        {% if field.name == 'rango_medida' or field.name == 'resolucion' or field.name == 'error_maximo_permisible' %}
                            <div>
                                <label for="{{ field.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-1">{{ field.label }}:</label>
                                {{ field }}
                                {% if field.help_text %}<p class="text-gray-500 text-xs mt-1">{{ field.help_text }}</p>{% endif %}
                                {% for error in field.errors %}<p class="text-red-500 text-xs">{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="mt-3">
                    {% for field in form %}
                        {% if field.name == 'puntos_calibracion' %}
                            <label for="{{ field.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-1">{{ field.label }}:</label>
                            {{ field }}
                            {% if field.help_text %}<p class="text-gray-500 text-xs mt-1">{{ field.help_text }}</p>{% endif %}
                            {% for error in field.errors %}<p class="text-red-500 text-xs">{{ error }}</p>{% endfor %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            {# === SECCIÓN: Fechas y Frecuencias === #}
            <div class="border border-gray-200 rounded-lg p-4 mb-5">
                <h3 class="text-sm font-semibold text-indigo-700 uppercase tracking-wide mb-3">Fechas y Frecuencias</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-3">
                    {% for field in form %}
                        {% if field.name == 'fecha_adquisicion' %}
                            <div>
                                <label for="{{ field.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-1">{{ field.label }}:</label>
                                {{ field }}
                                {% if field.help_text %}<p class="text-gray-500 text-xs mt-1">{{ field.help_text }}</p>{% endif %}
                                {% for error in field.errors %}<p class="text-red-500 text-xs">{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-3 mt-3 pt-3 border-t border-gray-100">
                    {% for field in form %}
                        {% if field.name == 'fecha_ultima_calibracion' or field.name == 'frecuencia_calibracion_meses' or field.name == 'fecha_ultimo_mantenimiento' or field.name == 'frecuencia_mantenimiento_meses' or field.name == 'fecha_ultima_comprobacion' or field.name == 'frecuencia_comprobacion_meses' %}
                            <div>
                                <label for="{{ field.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-1">{{ field.label }}:</label>
                                {% if field.name == 'fecha_ultima_calibracion' or field.name == 'fecha_ultimo_mantenimiento' or field.name == 'fecha_ultima_comprobacion' %}
                                    <input type="date" name="{{ field.name }}" id="{{ field.id_for_label }}"
                                           class="form-input"
                                           value="{{ field.value|date:'Y-m-d'|default:'' }}"
                                           {% if field.field.required %}required{% endif %}>
                                {% else %}
                                    {{ field }}
                                {% endif %}
                                {% if field.help_text %}<p class="text-gray-500 text-xs mt-1">{{ field.help_text }}</p>{% endif %}
                                {% for error in field.errors %}<p class="text-red-500 text-xs">{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            {# === SECCIÓN: Documentos e Imagen === #}
            <div class="border border-gray-200 rounded-lg p-4 mb-5">
                <h3 class="text-sm font-semibold text-indigo-700 uppercase tracking-wide mb-3">Documentos e Imagen</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
                    {% for field in form %}
                        {% if field.name == 'archivo_compra_pdf' or field.name == 'manual_pdf' or field.name == 'otros_documentos_pdf' or field.name == 'imagen_equipo' %}
                            <div>
                                <label for="{{ field.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-1">{{ field.label }}:</label>
                                {{ field }}
                                {% if field.help_text %}<p class="text-gray-500 text-xs mt-1">{{ field.help_text }}</p>{% endif %}
                                {% for error in field.errors %}<p class="text-red-500 text-xs">{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            {# === SECCIÓN: Observaciones === #}
            <div class="border border-gray-200 rounded-lg p-4 mb-5">
                <h3 class="text-sm font-semibold text-indigo-700 uppercase tracking-wide mb-3">Observaciones</h3>
                {% for field in form %}
                    {% if field.name == 'observaciones' %}
                        {{ field }}
                        {% if field.help_text %}<p class="text-gray-500 text-xs mt-1">{{ field.help_text }}</p>{% endif %}
                        {% for error in field.errors %}<p class="text-red-500 text-xs">{{ error }}</p>{% endfor %}
                    {% endif %}
                {% endfor %}
            </div>

            {% if form.non_field_errors %}
                <div class="bg-red-50 border-l-4 border-red-500 p-3 mb-4 rounded">
                    {% for error in form.non_field_errors %}<p class="text-red-600 text-sm">{{ error }}</p>{% endfor %}
                </div>
            {% endif %}

            <div class="flex items-center justify-end space-x-4 pt-2">
                <button type="submit"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300
                               {% if limite_alcanzado %}opacity-50 cursor-not-allowed{% endif %}"
                        {% if limite_alcanzado %}disabled title="Límite de equipos alcanzado para esta empresa"{% endif %}>
                    Guardar Equipo
                </button>
                <a href="{% url 'core:home' %}" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}
