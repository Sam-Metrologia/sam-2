# GitHub Action: VerificaciÃ³n Mensual de Empresas Eliminadas
# Se ejecuta automÃ¡ticamente el primer dÃ­a de cada mes
# NO ELIMINA NADA - Solo genera un reporte para revisiÃ³n

name: VerificaciÃ³n Mensual de Empresas Eliminadas

on:
  schedule:
    # Primer dÃ­a de cada mes a las 2:00 AM Colombia (7:00 UTC)
    - cron: '0 7 1 * *'
  workflow_dispatch:  # Permite ejecuciÃ³n manual

jobs:
  check-deleted-companies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: Configurar Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          pip install django python-dotenv

      - name: Verificar empresas elegibles para eliminaciÃ³n (DRY-RUN)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          echo "=== VERIFICACIÃ“N DE EMPRESAS ELIMINADAS ==="
          echo "Fecha: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "NOTA: Esta es solo una verificaciÃ³n. NO se eliminarÃ¡ nada."
          echo ""

          # Ejecutar comando en modo dry-run (sin --execute)
          python manage.py cleanup_deleted_companies --days=180 > cleanup_report.txt 2>&1 || true

          # Mostrar reporte
          cat cleanup_report.txt

      - name: Guardar reporte como artefacto
        uses: actions/upload-artifact@v3
        with:
          name: cleanup-report-${{ github.run_number }}
          path: cleanup_report.txt
          retention-days: 90

      - name: Mostrar resumen del reporte
        run: |
          echo ""
          echo "=== RESUMEN DEL REPORTE ==="
          echo ""
          cat cleanup_report.txt
          echo ""
          echo "=== INSTRUCCIONES ==="
          echo ""
          echo "ğŸ“„ El reporte completo estÃ¡ guardado como artefacto en esta ejecuciÃ³n"
          echo "ğŸ“‹ Para revisar el reporte:"
          echo "   1. Ve a la pestaÃ±a 'Summary' de esta ejecuciÃ³n"
          echo "   2. Descarga el artefacto 'cleanup-report-${{ github.run_number }}'"
          echo ""
          echo "âœ… Si hay empresas para eliminar y estÃ¡s de acuerdo:"
          echo "   1. Ve a: https://github.com/${{ github.repository }}/actions/workflows/cleanup-execute.yml"
          echo "   2. Click en 'Run workflow'"
          echo "   3. Escribe 'CONFIRMO' para autorizar"
          echo ""
          echo "âš ï¸ IMPORTANTE: Esta verificaciÃ³n NO eliminÃ³ nada"

      - name: Resumen
        if: always()
        run: |
          echo ""
          echo "âœ… VerificaciÃ³n completada"
          echo "ğŸ“„ Reporte guardado como artefacto"
          echo "ğŸ“‹ Issue creado para revisiÃ³n"
          echo ""
          echo "ğŸ‘‰ Revisa el issue creado en GitHub para ver el reporte completo"
