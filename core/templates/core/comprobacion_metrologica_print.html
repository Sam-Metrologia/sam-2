<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Comprobación Metrológica - {{ equipo.nombre }}</title>
    <style>
        @page {
            size: A4;
            margin: 1.2cm 1cm;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 8.5pt;
            line-height: 1.3;
            color: #2D3748;
        }

        /* ENCABEZADO CORPORATIVO */
        .header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
            border: 1px solid #000;
        }

        .header-table td {
            border: 1px solid #000;
            padding: 6px;
            vertical-align: middle;
        }

        .header-logo-cell {
            width: 25%;
            text-align: center;
        }

        .header-logo {
            max-width: 70px;
            max-height: 70px;
        }

        .header-title-cell {
            width: 50%;
            text-align: center;
            font-size: 14pt;
            font-weight: bold;
            color: #2D3748;
        }

        .header-info-cell {
            width: 25%;
            font-size: 8pt;
            color: #2D3748;
        }

        .header-info-cell p {
            margin: 2px 0;
        }

        /* SECCIONES */
        .section {
            margin: 10px 0;
            page-break-inside: avoid;
        }

        .section-title {
            font-size: 11pt;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #4A5568 0%, #5A6C7D 100%);
            padding: 5px 10px;
            margin: 0 0 8px 0;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(74, 85, 104, 0.3);
        }

        /* INFORMACIÓN EN GRID */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin: 6px 0;
        }

        .info-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin: 6px 0;
        }

        .info-item {
            background: #F7FAFC;
            padding: 4px 8px;
            border-left: 2px solid #4A5568;
            font-size: 8.5pt;
        }

        .info-item strong {
            color: #4A5568;
            font-weight: 600;
            display: block;
            margin-bottom: 2px;
            font-size: 8pt;
        }

        .info-value {
            color: #2c3e50;
            font-weight: 500;
        }

        /* HIGHLIGHT BOX */
        .highlight-box {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border-left: 4px solid #f39c12;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .highlight-box strong {
            color: #875a0c;
            font-weight: 700;
        }

        /* TABLAS */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table th {
            background: linear-gradient(135deg, #4A5568 0%, #5A6C7D 100%);
            color: white;
            font-weight: 700;
            text-align: center;
            padding: 8px 5px;
            font-size: 8.5pt;
            border: 1px solid #2D3748;
        }

        table td {
            border: 1px solid #d1d5db;
            padding: 6px 8px;
            font-size: 8.5pt;
        }

        /* TABLA DE MEDICIONES */
        .medicion-table th {
            font-size: 7.5pt;
            padding: 6px 3px;
        }

        .medicion-table td {
            text-align: center;
            font-size: 8pt;
        }

        /* ESTADOS DE CONFORMIDAD */
        .conforme {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            color: #155724;
            font-weight: 700;
        }

        .no-conforme {
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
            color: #721c24;
            font-weight: 700;
        }

        /* CAJAS DE RESUMEN */
        .resumen-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 15px 0;
        }

        .resumen-box {
            padding: 12px;
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .resumen-box.verde {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            border: 2px solid #10b981;
        }

        .resumen-box.rojo {
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
            border: 2px solid #ef4444;
        }

        .resumen-box.azul {
            background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
            border: 2px solid #3b82f6;
        }

        .resumen-box .label {
            font-size: 8pt;
            color: #1f2937;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .resumen-box .value {
            font-size: 20pt;
            font-weight: 700;
            color: #111827;
        }

        /* CAJA DE DECISIÓN */
        .decision-box {
            background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
            border: 3px solid #4A5568;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(26, 84, 144, 0.2);
        }

        .decision-box .label {
            font-size: 10pt;
            color: #1e40af;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .decision-box .value {
            font-size: 16pt;
            color: #1f2937;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* CAJA DE OBSERVACIONES */
        .observation-box {
            background: #f8f9fa;
            border: 2px solid #4A5568;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .observation-box p {
            margin: 6px 0;
            font-size: 9pt;
        }

        .observation-box strong {
            color: #4A5568;
            font-weight: 700;
        }

        /* GRÁFICA */
        .grafica-container {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #4A5568;
            border-radius: 6px;
            text-align: center;
        }

        .grafica-container canvas {
            max-width: 100%;
            height: auto;
        }

        /* PIE DE PÁGINA */
        .footer {
            margin-top: 25px;
            padding-top: 12px;
            border-top: 2px solid #4A5568;
            text-align: center;
            font-size: 7.5pt;
            color: #6B7280;
        }

        .page-break {
            page-break-after: always;
        }
    </style>
</head>
<body>
    <!-- ENCABEZADO CORPORATIVO -->
    <table class="header-table">
        <tr>
            <td class="header-logo-cell">
                {% if logo_empresa_url %}
                <img src="{{ logo_empresa_url }}" alt="Logo {{ empresa.nombre }}" class="header-logo">
                {% else %}
                <div style="font-size: 10pt; color: #4A5568; font-weight: bold;">{{ empresa.nombre }}</div>
                {% endif %}
            </td>
            <td class="header-title-cell">
                COMPROBACIÓN METROLÓGICA
            </td>
            <td class="header-info-cell">
                <p><strong>Código:</strong> {{ datos_comprobacion.formato_codigo|default:"SAM-COMP-001" }}</p>
                <p><strong>Versión:</strong> {{ datos_comprobacion.formato_version|default:"01" }}</p>
                {% if datos_comprobacion.formato_fecha or comprobacion.equipo.empresa.comprobacion_fecha_formato %}
                <p><strong>Fecha:</strong> {{ datos_comprobacion.formato_fecha|default:comprobacion.equipo.empresa.comprobacion_fecha_formato|date:"d/m/Y" }}</p>
                {% endif %}
            </td>
        </tr>
    </table>

    <!-- SECCIÓN 1: INFORMACIÓN DEL EQUIPO -->
    <div class="section">
        <div class="section-title">1. INFORMACIÓN DEL EQUIPO</div>
        <div class="info-grid">
            <div class="info-item">
                <strong>CÓDIGO INTERNO</strong>
                <div class="info-value">{{ equipo.codigo_interno }}</div>
            </div>
            <div class="info-item">
                <strong>NOMBRE DEL EQUIPO</strong>
                <div class="info-value">{{ equipo.nombre }}</div>
            </div>
            <div class="info-item">
                <strong>MARCA</strong>
                <div class="info-value">{{ equipo.marca|default:"N/A" }}</div>
            </div>
            <div class="info-item">
                <strong>MODELO</strong>
                <div class="info-value">{{ equipo.modelo|default:"N/A" }}</div>
            </div>
            <div class="info-item">
                <strong>SERIE</strong>
                <div class="info-value">{{ equipo.numero_serie|default:"N/A" }}</div>
            </div>
            <div class="info-item">
                <strong>RANGO DE MEDIDA</strong>
                <div class="info-value">{{ equipo.rango_medida|default:"N/A" }}</div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN 2: EQUIPO DE REFERENCIA -->
    {% if comprobacion.equipo_referencia_nombre or datos_comprobacion.equipo_ref_nombre %}
    <div class="section">
        <div class="section-title">2. EQUIPO DE REFERENCIA</div>
        <table>
            <thead>
                <tr>
                    <th style="width: 25%;">Nombre del Equipo</th>
                    <th style="width: 25%;">Marca</th>
                    <th style="width: 25%;">Modelo</th>
                    <th style="width: 25%;">Certificado de Calibración</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{ comprobacion.equipo_referencia_nombre|default:datos_comprobacion.equipo_ref_nombre|default:"N/A" }}</td>
                    <td>{{ comprobacion.equipo_referencia_marca|default:datos_comprobacion.equipo_ref_marca|default:"N/A" }}</td>
                    <td>{{ comprobacion.equipo_referencia_modelo|default:datos_comprobacion.equipo_ref_modelo|default:"N/A" }}</td>
                    <td>{{ comprobacion.equipo_referencia_certificado|default:datos_comprobacion.equipo_ref_certificado|default:"N/A" }}</td>
                </tr>
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- SECCIÓN 3: RESUMEN DE CONFORMIDAD -->
    <div class="section">
        <div class="section-title">{% if comprobacion.equipo_referencia_nombre or datos_comprobacion.equipo_ref_nombre %}3{% else %}2{% endif %}. RESUMEN DE CONFORMIDAD</div>
        <div class="resumen-grid">
            <div class="resumen-box verde">
                <div class="label">PUNTOS CONFORMES</div>
                <div class="value">{{ puntos_conformes }}</div>
            </div>
            <div class="resumen-box rojo">
                <div class="label">PUNTOS NO CONFORMES</div>
                <div class="value">{{ puntos_no_conformes }}</div>
            </div>
            <div class="resumen-box azul">
                <div class="label">TOTAL DE PUNTOS</div>
                <div class="value">{{ total_puntos }}</div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN 4: RESULTADOS DE MEDICIÓN -->
    <div class="section">
        <div class="section-title">{% if comprobacion.equipo_referencia_nombre or datos_comprobacion.equipo_ref_nombre %}4{% else %}3{% endif %}. RESULTADOS DE MEDICIÓN</div>
        <table class="medicion-table">
            <thead>
                <tr>
                    <th style="width: 4%;">#</th>
                    <th style="width: 9%;">Valor<br>Nominal<br>({{ datos_comprobacion.unidad_equipo|default:"mm" }})</th>
                    <th style="width: 9%;">Lectura<br>({{ datos_comprobacion.unidad_equipo|default:"mm" }})</th>
                    <th style="width: 8%;">EMP<br>Valor</th>
                    <th style="width: 7%;">EMP<br>Tipo</th>
                    <th style="width: 9%;">EMP<br>Absoluto<br>({{ datos_comprobacion.unidad_equipo|default:"mm" }})</th>
                    <th style="width: 9%;">Error<br>({{ datos_comprobacion.unidad_equipo|default:"mm" }})</th>
                    <th style="width: 10%;">Límite<br>Superior<br>({{ datos_comprobacion.unidad_equipo|default:"mm" }})</th>
                    <th style="width: 10%;">Límite<br>Inferior<br>({{ datos_comprobacion.unidad_equipo|default:"mm" }})</th>
                    <th style="width: 12%;">Conformidad</th>
                </tr>
            </thead>
            <tbody>
                {% for punto in datos_comprobacion.puntos_medicion %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ punto.nominal|floatformat:3 }}</td>
                    <td>{{ punto.lectura|floatformat:3 }}</td>
                    <td>{{ punto.emp_valor|floatformat:3 }}</td>
                    <td>{{ punto.emp_tipo }}</td>
                    <td>{{ punto.emp_absoluto|floatformat:3 }}</td>
                    <td>{{ punto.error|floatformat:3 }}</td>
                    <td>{{ punto.limite_superior|floatformat:3 }}</td>
                    <td>{{ punto.limite_inferior|floatformat:3 }}</td>
                    <td class="{% if punto.conformidad == 'CONFORME' %}conforme{% else %}no-conforme{% endif %}">
                        {{ punto.conformidad }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- SECCIÓN 5: GRÁFICA DE TENDENCIAS -->
    <div class="section">
        <div class="section-title">{% if comprobacion.equipo_referencia_nombre or datos_comprobacion.equipo_ref_nombre %}5{% else %}4{% endif %}. GRÁFICA DE ERRORES VS LÍMITES EMP</div>
        <div class="grafica-container">
            {{ grafica_svg|safe }}
            <p style="font-size: 8pt; color: #6B7280; margin-top: 10px;">
                <strong>Puntos azules:</strong> Errores conformes |
                <strong>Puntos rojos:</strong> Errores no conformes |
                <strong>Líneas rojas discontinuas:</strong> Límites EMP ±
            </p>
        </div>
    </div>

    <!-- SECCIÓN 6: OBSERVACIONES -->
    {% if comprobacion.observaciones %}
    <div class="section">
        <div class="section-title">{% if comprobacion.equipo_referencia_nombre or datos_comprobacion.equipo_ref_nombre %}6{% else %}5{% endif %}. OBSERVACIONES</div>
        <div class="observation-box">
            <p>{{ comprobacion.observaciones }}</p>
        </div>
    </div>
    {% endif %}

    <!-- SECCIÓN 7: CONCLUSIÓN -->
    <div class="section">
        <div class="section-title">
            {% if comprobacion.equipo_referencia_nombre or datos_comprobacion.equipo_ref_nombre %}
                {% if comprobacion.observaciones %}7{% else %}6{% endif %}
            {% else %}
                {% if comprobacion.observaciones %}6{% else %}5{% endif %}
            {% endif %}. CONCLUSIÓN
        </div>
        <div class="decision-box">
            <div class="label">RESULTADO FINAL</div>
            <div class="value" style="color: {% if comprobacion.resultado == 'Aprobado' %}#155724{% else %}#721c24{% endif %};">
                {% if comprobacion.resultado == 'Aprobado' %}
                ✓ APROBADO
                {% else %}
                ✗ NO APROBADO
                {% endif %}
            </div>
            <p style="margin-top: 10px; font-size: 9pt; color: #374151;">
                El equipo <strong>{{ equipo.codigo_interno }} - {{ equipo.nombre }}</strong>
                {% if comprobacion.resultado == 'Aprobado' %}
                <strong>CUMPLE</strong> con las tolerancias establecidas en la comprobación metrológica.
                {% else %}
                <strong>NO CUMPLE</strong> con las tolerancias establecidas. Se requiere acción correctiva.
                {% endif %}
            </p>
        </div>
    </div>

    <!-- PIE DE PÁGINA -->
    <div class="footer">
        <p><strong>{{ empresa.nombre }}</strong></p>
        <p>Documento generado el {{ fecha_generacion|date:"d/m/Y H:i" }}</p>
    </div>
</body>
</html>
